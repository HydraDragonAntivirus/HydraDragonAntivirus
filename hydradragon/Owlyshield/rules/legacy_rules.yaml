- name: "Unified_Generic_Stealer_Detection"
  description: "Comprehensive multi-stage detection for credential stealers covering: Recon -> Browser/Wallet/Discord Theft -> Staging -> Persistence -> Exfiltration -> Hiding."
  
  # --- Metadata ---
  author: "Emirhan Ucan"
  severity: 90
  level: critical
  status: stable
  
  mitre_attack:
    - "T1555.003"  # Credentials from Web Browsers
    - "T1074.001"  # Data Staged: Local Data Staging
    - "T1560"      # Archive Collected Data
    - "T1041"      # Exfiltration Over C2 Channel
    - "T1005"      # Data from Local System
    - "T1082"      # System Information Discovery
    - "T1016"      # System Network Configuration Discovery
    - "T1087"      # Account Discovery
    - "T1489"      # Service Stop (Browser Kill)
    - "T1547.001"  # Registry Run Keys / Startup
    - "T1564.001"  # Hidden Files
  
  tags:
    - "credential_theft"
    - "browser_stealer"
    - "discord_theft"
    - "crypto_theft"
    - "data_exfiltration"
    - "persistence"
    - "evasion"
  
  # --- Legacy Stealer Logic Support (Hardcoded Engine Checks) ---
  browser_paths:
    - "Google\\Chrome\\User Data"
    - "Microsoft\\Edge\\User Data"
    - "BraveSoftware\\Brave-Browser\\User Data"
    - "Opera Software\\Opera Stable"
    - "Mozilla\\Firefox\\Profiles"
    - "Discord\\Local Storage"
    - "Vivaldi\\User Data"
    - "Yandex\\YandexBrowser\\User Data"
  
  sensitive_files:
    - "Login Data"
    - "Cookies"
    - "Web Data"
    - "Local State"
    - "cookies.sqlite"
    - "logins.json"
    - "key4.db"
    - "wallet.dat"
    - "exodus.wallet"
  
  staging_paths:
    - "AppData\\Local\\Temp"
    - "ProgramData"
    - "Temp"
  
  # --- Stage Correlation Configuration ---
  min_stages_satisfied: 1
  time_window_ms: 1200000  # 2* minutes correlation window
  conditions_percentage: 0.30
  
  # Python processes get immediate memory scans
  record_on_start:
    - "*.exe"
  
  stages:
    # ========================================================================
    # STAGE 1: Sensitive Browser Data Access
    # ========================================================================
    - name: "Browser_Credential_Database_Access"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\*\\Login Data"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\*\\Cookies"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Profiles\\*\\cookies.sqlite"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Profiles\\*\\logins.json"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\Local State"
        
        - type: "Heuristic"
          metric: "Entropy"
          threshold: 6.5
        
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 3
          patterns:
            - "*\\Google\\Chrome\\User Data\\*"
            - "*\\Microsoft\\Edge\\User Data\\*"
            - "*\\BraveSoftware\\Brave-Browser\\User Data\\*"
            - "*\\Opera Software\\Opera*\\*"
            - "*\\Mozilla\\Firefox\\Profiles\\*"
        
        - type: "MemoryScan"
          patterns:
            - "CryptUnprotectData"
            - "os_crypt"
            - "encrypted_key"
          detect_pe_headers: false
          private_only: false

    # ========================================================================
    # STAGE 2: Credential Decryption and Collection
    # ========================================================================
    - name: "Credential_Decryption_Processing"
      conditions:
        - type: "MemoryScan"
          patterns:
            - "CryptUnprotectData"
            - "Crypt32"
            - "DPAPI"
          detect_pe_headers: false
          private_only: false
        
        - type: "MemoryScan"
          patterns:
            - "v10"
            - "v11"
            - "v20"
            - "AES"
            - "GCM"
          detect_pe_headers: false
          private_only: false
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*.db"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*.sqlite"
        
        - type: "FileCount"
          category: "read"
          comparison: "gte"
          threshold: 10

    # ========================================================================
    # STAGE 3: Data Staging and Organization
    # ========================================================================
    - name: "Stolen_Data_Staging"
      conditions:
        - type: "TempDirectoryWrite"
          min_bytes: 10240
          min_files: 3
        
        - type: "ArchiveCreation"
          extensions: ["zip", "rar", "7z", "tar", "gz"]
          min_size: 5120
          in_temp: true
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\Passwords.txt"
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\Cookies.txt"
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\Autofill*.txt"
        
        - type: "ExtensionPattern"
          op_type: "Write"
          match_mode: "any"
          patterns: 
            - "*.zip"
            - "*.tmp"
            - "*.dat"
            - "*.txt"
        
        - type: "ByteThreshold"
          direction: "write"
          comparison: "gte"
          threshold: 51200

    # ========================================================================
    # STAGE 4: Network Exfiltration
    # ========================================================================
    - name: "Data_Exfiltration_Network"
      conditions:
        - type: "Network"
          op: "Connect"
        
        - type: "ByteThreshold"
          direction: "write"
          comparison: "gte"
          threshold: 102400
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*discord.com/api/webhooks/*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*api.telegram.org/bot*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*gofile.io*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*anonfiles.com*"
        
        - type: "MemoryScan"
          patterns:
            - "webhook"
            - "uploadFile"
            - "multipart/form-data"
            - "Content-Disposition"
          detect_pe_headers: false
          private_only: false

    # ========================================================================
    # STAGE 5: System Reconnaissance (New)
    # ========================================================================
    - name: "System_Reconnaissance"
      conditions:
        - type: "CommandLineMatch"
          # FIXED: 'at_least' is a variant requiring a value, so it must be a map
          match_mode:
            at_least: 2
          patterns:
            - pattern: "systeminfo"
              modifiers: ["nocase", "contains"]
            - pattern: "ipconfig"
              modifiers: ["nocase", "contains"]
            - pattern: "net user"
              modifiers: ["nocase", "contains"]
            - pattern: "tasklist"
              modifiers: ["nocase", "contains"]
            - pattern: "net localgroup"
              modifiers: ["nocase", "contains"]
            - pattern: "whoami"
              modifiers: ["nocase", "contains"]
            - pattern: "wmic"
              modifiers: ["nocase", "contains"]

    # ========================================================================
    # STAGE 6: Discord Token Theft (New)
    # ========================================================================
    - name: "Discord_Token_Theft"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*\\Discord*\\Local Storage\\leveldb\\*.ldb"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Discord*\\Local Storage\\leveldb\\*.log"

    # ========================================================================
    # STAGE 7: Crypto Wallet Theft (New)
    # ========================================================================
    - name: "Crypto_Wallet_Theft"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*\\wallet.dat"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\AppData\\Roaming\\Exodus\\exodus.wallet*"
          
        - type: "File"
          op: "Read"
          path_pattern: "*\\AppData\\Roaming\\Electrum\\wallets*"
          
        - type: "File"
          op: "Read"
          path_pattern: "*\\AppData\\Roaming\\Atomic\\Local Storage\\leveldb*"
          
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 1
          patterns:
            - "*\\Local Extension Settings\\nkbihfbeogaeaoehlefnkodbefgpgknn*" # Metamask
            - "*\\Local Extension Settings\\bfnaelmomeimhlpmgjnjophhpkkoljpa*" # Phantom
            - "*\\Local Extension Settings\\fhbohimaelbohpjbbldcngcnapndodjp*" # Binance

    # ========================================================================
    # STAGE 8: Browser Process Termination (New)
    # ========================================================================
    - name: "Browser_Process_Termination"
      conditions:
        # Requires both taskkill AND browser name in CLI
        - type: "CommandLineMatch"
          match_mode: "all"
          patterns:
            - pattern: "taskkill"
              modifiers: ["nocase", "contains"]
            - pattern: "/IM"
              modifiers: ["nocase", "contains"]
        
        - type: "CommandLineMatch"
          match_mode: "any"
          patterns:
            - pattern: "chrome"
              modifiers: ["nocase", "contains"]
            - pattern: "firefox"
              modifiers: ["nocase", "contains"]
            - pattern: "brave"
              modifiers: ["nocase", "contains"]
            - pattern: "opera"
              modifiers: ["nocase", "contains"]
            - pattern: "msedge"
              modifiers: ["nocase", "contains"]

    # ========================================================================
    # STAGE 9: Persistence Establishment (New)
    # ========================================================================
    - name: "Persistence_Establishment"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\CurrentVersion\\Run\\*"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*.exe"
          
        - type: "File"
          op: "Create"
          path_pattern: "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*.bat"

    # ========================================================================
    # STAGE 10: Artifact Hiding (New)
    # ========================================================================
    - name: "Artifact_Hiding"
      conditions:
        - type: "CommandLineMatch"
          match_mode: "all"
          patterns:
            - pattern: "attrib"
              modifiers: ["nocase", "contains"]
            - pattern: "+h"
              modifiers: ["nocase", "contains"]
            - pattern: "+s"
              modifiers: ["nocase", "contains"]

  # --- Correlation Mapping ---
  mapping:
    or:
      # Require memory scan + behavioral indicators
      - and:
          - stage: "Credential_Decryption_Processing"
          - or:
            - stage: "Stolen_Data_Staging"
            - stage: "Data_Exfiltration_Network"

      # 2. Classic Browser Theft Chain (Access + Staging + Exfil)
      - and:
          - stage: "Browser_Credential_Database_Access"
          - stage: "Stolen_Data_Staging"
          - stage: "Data_Exfiltration_Network"
      
      # 3. Discord/Wallet Theft + Staging (High Confidence)
      - and:
          - or:
            - stage: "Discord_Token_Theft"
            - stage: "Crypto_Wallet_Theft"
          - stage: "Stolen_Data_Staging"
      
      # 4. Recon + Staging (Behavioral)
      - and:
          - stage: "System_Reconnaissance"
          - stage: "Stolen_Data_Staging"
      
      # 5. Browser Kill + Access (Evasion + Theft)
      - and:
          - stage: "Browser_Process_Termination"
          - stage: "Browser_Credential_Database_Access"

      # 6. Persistence + Hiding (Evasion Chain)
      - and:
          - stage: "Persistence_Establishment"
          - stage: "Artifact_Hiding"

  # ========================================================================
  # ADVANCED SIGNATURE-BASED ALLOWLISTING
  # ========================================================================
  allowlisted_apps:
    # -----------------------------------------------------------------------
    # Legitimate Browsers (Complex signature validation)
    # -----------------------------------------------------------------------
    - pattern: "chrome.exe"
      must_be_signed: true
      signers:
        - "Google LLC"
        - "Google Inc"
    
    - pattern: "msedge.exe"
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
        - "Microsoft Windows"
    
    - pattern: "firefox.exe"
      must_be_signed: true
      signers:
        - "Mozilla Corporation"
        - "Mozilla Foundation"
    
    - pattern: "brave.exe"
      must_be_signed: true
      signers:
        - "Brave Software, Inc."
    
    - pattern: "opera.exe"
      must_be_signed: true
      signers:
        - "Opera Norway AS"
        - "Opera Software AS"
    
    - pattern: "vivaldi.exe"
      must_be_signed: true
      signers:
        - "Vivaldi Technologies AS"
    
    # -----------------------------------------------------------------------
    # System Processes (Strict Microsoft signatures)
    # -----------------------------------------------------------------------
    - pattern: "explorer.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "svchost.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "taskmgr.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "powershell.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "cmd.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    # -----------------------------------------------------------------------
    # Password Managers (Legitimate credential access)
    # -----------------------------------------------------------------------
    - pattern: "1Password.exe"
      must_be_signed: true
      signers:
        - "AgileBits Inc."
    
    - pattern: "KeePass.exe"
      must_be_signed: true
      signers:
        - "Dominik Reichl"
    
    - pattern: "Bitwarden.exe"
      must_be_signed: true
      signers:
        - "8bit Solutions LLC"
        - "Bitwarden Inc."
    
    - pattern: "LastPass.exe"
      must_be_signed: true
      signers:
        - "LogMeIn, Inc."
        - "LastPass"
    
    - pattern: "Dashlane.exe"
      must_be_signed: true
      signers:
        - "Dashlane SAS"
        - "Dashlane Inc."
    
    # -----------------------------------------------------------------------
    # Development Tools (May legitimately access browser data)
    # -----------------------------------------------------------------------
    - pattern: "code.exe"
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
    
    - pattern: "devenv.exe"  # Visual Studio
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
    
    - pattern: "pycharm64.exe"
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    - pattern: "idea64.exe"  # IntelliJ
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    - pattern: "rider64.exe"  # Rider
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    - pattern: "webstorm64.exe"
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    # -----------------------------------------------------------------------
    # Security Software (Legitimate scanning of browser data)
    # -----------------------------------------------------------------------
    - pattern: "MsMpEng.exe"  # Windows Defender
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "avp.exe"  # Kaspersky
      must_be_signed: true
      signers:
        - "AO Kaspersky Lab"
        - "Kaspersky Lab"
    
    - pattern: "avgnt.exe"  # Avira
      must_be_signed: true
      signers:
        - "Avira Operations GmbH & Co. KG"
    
    - pattern: "bdagent.exe"  # Bitdefender
      must_be_signed: true
      signers:
        - "BITDEFENDER SRL"
    
    - pattern: "NortonSecurity.exe"
      must_be_signed: true
      signers:
        - "Symantec Corporation"
        - "NortonLifeLock Inc."
    
    - pattern: "mcshield.exe"  # McAfee
      must_be_signed: true
      signers:
        - "McAfee, Inc."
        - "McAfee, LLC"
    
    # -----------------------------------------------------------------------
    # Backup Software (May access browser data for backup)
    # -----------------------------------------------------------------------
    - pattern: "Acronis.exe"
      must_be_signed: true
      signers:
        - "Acronis International GmbH"
    
    - pattern: "CrashPlan.exe"
      must_be_signed: true
      signers:
        - "Code42 Software, Inc."
    
    - pattern: "SyncBackPro.exe"
      must_be_signed: true
      signers:
        - "2BrightSparks Pte Ltd"
    
    # -----------------------------------------------------------------------
    # Cloud Sync Services (May access local files)
    # -----------------------------------------------------------------------
    - pattern: "Dropbox.exe"
      must_be_signed: true
      signers:
        - "Dropbox, Inc."
    
    - pattern: "GoogleDrive.exe"
      must_be_signed: true
      signers:
        - "Google LLC"
    
    - pattern: "OneDrive.exe"
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
    
    - pattern: "Nextcloud.exe"
      must_be_signed: true
      signers:
        - "Nextcloud GmbH"
    
    # -----------------------------------------------------------------------
    # Browser Extensions/Helper Processes
    # -----------------------------------------------------------------------
    - pattern: "nacl64.exe"  # Chrome Native Client
      must_be_signed: true
      signers:
        - "Google LLC"
    
    - pattern: "elevation_service.exe"  # Chrome elevation
      must_be_signed: true
      signers:
        - "Google LLC"
    
    - pattern: "plugin-container.exe"  # Firefox plugins
      must_be_signed: true
      signers:
        - "Mozilla Corporation"
    
    # -----------------------------------------------------------------------
    # System Utilities (Signed by Microsoft or verified vendors)
    # -----------------------------------------------------------------------
    - pattern: "robocopy.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
    
    - pattern: "xcopy.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
    
    - pattern: "7z.exe"
      must_be_signed: true
      signers:
        - "Igor Pavlov"
    
    - pattern: "WinRAR.exe"
      must_be_signed: true
      signers:
        - "Alexander Roshal"
        - "win.rar GmbH"

  # ========================================================================
  # Memory Scan Configuration
  # ========================================================================
  memory_scan_config:
    target_processes:
      - "*.exe"
    scan_on_io_event: true
    scan_every_n_ops: 5
    min_scan_interval_secs: 10

  # ========================================================================
  # Response Actions
  # ========================================================================
  response:
    record: true              # Enable detailed logging
    terminate_process: true   # Kill the malicious process
    quarantine: true          # Move executable to quarantine
    suspend_process: false    # Don't just suspend, terminate
    auto_revert: true         # Revert file changes if possible
  
  proximity_log_threshold: 70.0
  debug: false
