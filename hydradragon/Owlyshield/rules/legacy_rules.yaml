- name: "Exela_Stealer_Enhanced_Detection"
  description: "Python-focused detection for Exela stealer with unique behavioral signatures, memory patterns, and file operations"
  
  author: "Emirhan Ucan"
  severity: 99
  level: critical
  status: stable
  
  mitre_attack: 
    - "T1059.006"  # Python
    - "T1555.003"  # Credentials from Web Browsers
    - "T1539"      # Steal Web Session Cookie
    - "T1005"      # Data from Local System
    - "T1074.001"  # Local Data Staging
    - "T1560"      # Archive Collected Data
    - "T1041"      # Exfiltration Over C2 Channel
  
  tags:
    - "exela"
    - "python_stealer"
    - "credential_theft"
    - "browser_hijacking"
    - "discord_injection"
  
  # Lower thresholds for Python processes
  require_internet: true
  multi_access_threshold: 2
  entropy_threshold: 6.0
  conditions_percentage: 0.40
  min_stages_satisfied: 2
  time_window_ms: 180000  # 3 minutes for Python's slower execution
  
  # Python process names to monitor
  record_on_start:
    - "python.exe"
    - "pythonw.exe"
    - "python3.exe"
  
  browser_paths:
    - "*\\Google\\Chrome\\User Data*"
    - "*\\Microsoft\\Edge\\User Data*"
    - "*\\BraveSoftware\\Brave-Browser\\User Data*"
    - "*\\Opera Software\\Opera*"
    - "*\\Mozilla\\Firefox\\Profiles*"
    - "*\\Discord*"
  
  sensitive_files:
    - "Login Data"
    - "Cookies"
    - "Web Data"
    - "Local State"
    - "cookies.sqlite"
    - "places.sqlite"
  
  staging_paths:
    - "*\\AppData\\Local\\Temp*"
    - "*\\Temp*"
  
  suspicious_parents:
    - "cmd.exe"
    - "powershell.exe"
    - "wscript.exe"
    - "explorer.exe"
  
  stages:
    # ============================================================================
    # STAGE 1: Exela-Specific Identifiers (UNIQUE TO EXELA)
    # ============================================================================
    - name: "Exela_Unique_Identifiers"
      conditions:
        # Mutex pattern (Line 140)
        - type: "MemoryScan"
          patterns:
            - "Exela | Stealar | on top |"
            - "Exela"
            - "quicaxd"
          detect_pe_headers: false
          private_only: false
        
        # Telegram branding
        - type: "MemoryScan"
          patterns:
            - "t.me/ExelaStealer"
            - "ExelaStealer"
            - "github.com/quicaxd/Exela"
          detect_pe_headers: false
          private_only: false
        
        # Specific directory creation
        - type: "File"
          op: "Create"
          path_pattern: "*\\ExelaUpdateService\\*"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\StealedFilesByExela\\*"
        
        # Injection URL
        - type: "Network"
          op: "Connect"
          dest_pattern: "*raw.githubusercontent.com/justforExela/injection*"

    # ============================================================================
    # STAGE 2: Python Process with Browser Database Copying
    # ============================================================================
    - name: "Python_Browser_Database_Theft"
      conditions:
        # Python process ancestry
        - type: "ProcessAncestry"
          ancestor_pattern: "*python*"
          max_depth: 3
        
        # Specific temp database files (Lines 282-291)
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\Logins.db"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\Web.db"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\Cookies.db"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\HistoryData.db"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\AutofillData.db"
        
        # Read browser Local State for decryption key
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\Local State"

    # ============================================================================
    # STAGE 3: WMIC UUID Enumeration Pattern
    # ============================================================================
    - name: "UUID_Based_AntiVM_AntiDebug"
      conditions:
        # UUID retrieval (Line 145, 773)
        - type: "Process"
          op: "CommandLine"
          pattern: "*wmic*csproduct*get*uuid*"
        
        # Computer name retrieval
        - type: "Process"
          op: "CommandLine"
          pattern: "*computername*"
        
        # Banned UUID checks (hardcoded VM detection)
        - type: "MemoryScan"
          patterns:
            - "7AB5C494-39F5-4941-9163-47F54D6D5016"
            - "032E02B4-0499-05C3-0806-3C0700080009"
            - "ADEEEE9E-EF0A-6B84-B14B-B83A54AFC548"
          detect_pe_headers: false
          private_only: false
        
        # Banned process names
        - type: "Process"
          op: "CommandLine"
          pattern: "*taskkill*/F*/IM*processhacker*"
        
        - type: "Process"
          op: "CommandLine"
          pattern: "*taskkill*/F*/IM*wireshark*"

    # ============================================================================
    # STAGE 4: CryptUnprotectData & Browser Decryption
    # ============================================================================
    - name: "DPAPI_Browser_Decryption"
      conditions:
        # Memory scan for DPAPI structures (Lines 63-93)
        - type: "MemoryScan"
          patterns:
            - "CryptUnprotectData"
            - "Crypt32"
            - "os_crypt"
            - "encrypted_key"
          detect_pe_headers: false
          private_only: false
        
        # AES-GCM decryption patterns (v10/v11 format)
        - type: "MemoryScan"
          patterns:
            - "v10"
            - "v11"
            - "GCM"
          detect_pe_headers: false
          private_only: false
        
        # Read Local State JSON
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 1
          patterns:
            - "*\\Local State"

    # ============================================================================
    # STAGE 5: Discord Injection with Specific Pattern
    # ============================================================================
    - name: "Discord_Injection_Exela_Pattern"
      conditions:
        # Token regex pattern (Line 708)
        - type: "MemoryScan"
          patterns:
            - "dQw4w9WgXcQ:"
            - "[\w-]{24}\.[\w-]{6}\.[\w-]{25,110}"
          detect_pe_headers: false
          private_only: false
        
        # Discord API validation
        - type: "Network"
          op: "Connect"
          dest_pattern: "*discord.com/api/v8/users/@me*"
        
        # Fetch injection script from GitHub
        - type: "Network"
          op: "Connect"
          dest_pattern: "*raw.githubusercontent.com*injection*"
        
        # Modify Discord core
        - type: "File"
          op: "Write"
          path_pattern: "*\\discord_desktop_core\\index.js"
        
        # Restart Discord
        - type: "Process"
          op: "CommandLine"
          pattern: "*Update.exe*--processStart*Discord.exe*"

    # ============================================================================
    # STAGE 6: Specific Social Media API Patterns
    # ============================================================================
    - name: "Social_Media_API_Harvesting"
      conditions:
        # Instagram mobile API (Line 458)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*i.instagram.com/api/v1/accounts/current_user/?edit=true*"
        
        # TikTok wallet API (Line 504)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*webcast.tiktok.com/webcast/wallet_api/diamond_buy/permission*"
        
        # Twitter OAuth2 (Line 557)
        - type: "MemoryScan"
          patterns:
            - "AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs"
            - "x-twitter-auth-type"
            - "OAuth2Session"
          detect_pe_headers: false
          private_only: false
        
        # Reddit OAuth (Line 630)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*accounts.reddit.com/api/access_token*"
        
        - type: "MemoryScan"
          patterns:
            - "Basic b2hYcG9xclpZdWIxa2c6"
          detect_pe_headers: false
          private_only: false
        
        # Roblox currency API (Line 677)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*economy.roblox.com/v1/users/*/currency*"
        
        # Twitch GraphQL (Line 606)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*gql.twitch.tv/gql*"
        
        - type: "MemoryScan"
          patterns:
            - "bitsBalance"
            - "hasPrime"
            - "isPartner"
          detect_pe_headers: false
          private_only: false

    # ============================================================================
    # STAGE 7: Steam API with Specific Key
    # ============================================================================
    - name: "Steam_API_Session_Theft"
      conditions:
        # Hardcoded API key (Line 714)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=440D7F4D810EF9298D25EDDF37C1F902*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*api.steampowered.com/IPlayerService/GetSteamLevel/v1/?key=440D7F4D810EF9298D25EDDF37C1F902*"
        
        # Steam ID regex
        - type: "MemoryScan"
          patterns:
            - "7656[0-9]{13}"
          detect_pe_headers: false
          private_only: false
        
        # loginusers.vdf
        - type: "File"
          op: "Read"
          path_pattern: "*\\Steam\\config\\loginusers.vdf"

    # ============================================================================
    # STAGE 8: Network Geolocation API
    # ============================================================================
    - name: "Network_Reconnaissance_IPAPI"
      conditions:
        # Specific geolocation API (Line 189)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*ip-api.com/json*"
        
        - type: "MemoryScan"
          patterns:
            - "ip-api.com"
            - "query"
            - "country"
            - "timezone"
          detect_pe_headers: false
          private_only: false

    # ============================================================================
    # STAGE 9: WiFi Password Extraction Pattern
    # ============================================================================
    - name: "WiFi_Credential_Harvesting"
      conditions:
        # WiFi enumeration (Line 207)
        - type: "Process"
          op: "CommandLine"
          pattern: "*netsh*wlan*show*profiles*"
        
        # WiFi password extraction (Line 215)
        - type: "Process"
          op: "CommandLine"
          pattern: "*netsh*wlan*show*profile*key=clear*"
        
        # Key content regex
        - type: "MemoryScan"
          patterns:
            - "Key content"
            - "All User Profile"
          detect_pe_headers: false
          private_only: false

    # ============================================================================
    # STAGE 10: PowerShell Screenshot with Specific Encoding
    # ============================================================================
    - name: "PowerShell_Screenshot_Capture"
      conditions:
        # Specific Base64 command (Line 782)
        - type: "Process"
          op: "CommandLine"
          pattern: "*powershell*-EncodedCommand*JABzAG8AdQByAGMAZQAgAD0AIABAACIA*"
        
        # Screenshot class
        - type: "MemoryScan"
          patterns:
            - "CaptureScreens"
            - "CopyFromScreen"
            - "System.Drawing"
            - "System.Windows.Forms"
          detect_pe_headers: false
          private_only: false
        
        # Display PNG files
        - type: "File"
          op: "Create"
          path_pattern: "*\\Display (*).png"

    # ============================================================================
    # STAGE 11: Telegram Session Theft Pattern
    # ============================================================================
    - name: "Telegram_tdata_Theft"
      conditions:
        # Kill Telegram (Line 738)
        - type: "Process"
          op: "CommandLine"
          pattern: "*taskkill*/F*/IM*Telegram.exe*"
        
        # tdata directory access
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 2
          patterns:
            - "*\\Telegram Desktop\\tdata\\*"
            - "*\\Telegram Desktop\\tdata\\D877F783D5D3EF8C*"
            - "*\\Telegram Desktop\\tdata\\key_datas*"
        
        # Blacklisted directory names
        - type: "MemoryScan"
          patterns:
            - "dumps"
            - "emojis"
            - "tdummy"
            - "user_data#"
          detect_pe_headers: false
          private_only: false

    # ============================================================================
    # STAGE 12: UUID-Based Directory Structure
    # ============================================================================
    - name: "UUID_Staging_Directory"
      conditions:
        # UUID-based temp folder (Line 773)
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*\\Browsers\\*"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*\\Sessions\\*"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*\\Tokens\\*"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*\\Wallets\\*"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*\\Games\\*"
        
        # Specific text files
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\Passwords.txt"
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\system_info.txt"

    # ============================================================================
    # STAGE 13: GoFile Upload Pattern
    # ============================================================================
    - name: "GoFile_Exfiltration"
      conditions:
        # GoFile API calls (Line 963)
        - type: "Network"
          op: "Connect"
          dest_pattern: "*api.gofile.io/getServer*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*gofile.io/uploadFile*"
        
        - type: "MemoryScan"
          patterns:
            - "gofile.io"
            - "uploadFile"
            - "downloadPage"
          detect_pe_headers: false
          private_only: false

    # ============================================================================
    # STAGE 14: Discord Webhook with Embed Structure
    # ============================================================================
    - name: "Discord_Webhook_Exfiltration"
      conditions:
        # Webhook connection
        - type: "Network"
          op: "Connect"
          dest_pattern: "*discord.com/api/webhooks/*"
        
        # Specific embed structure (Line 421+)
        - type: "MemoryScan"
          patterns:
            - "***Exela Stealer***"
            - "Exela Stealer"
            - "embeds"
            - "thumbnail"
          detect_pe_headers: false
          private_only: false
        
        # i.hizliresim.com thumbnails
        - type: "MemoryScan"
          patterns:
            - "i.hizliresim.com"
            - "qxnzimj.jpg"
            - "6t31tw2.jpg"
          detect_pe_headers: false
          private_only: false

    # ============================================================================
    # STAGE 15: Persistence with Specific Names
    # ============================================================================
    - name: "ExelaUpdateService_Persistence"
      conditions:
        # Specific scheduled task names (Line 1022)
        - type: "Process"
          op: "CommandLine"
          pattern: "*schtasks*/create*/tn*ExelaUpdateService*"
        
        - type: "Process"
          op: "CommandLine"
          pattern: "*schtasks*/query*/TN*ExelaUpdateService*"
        
        # Registry persistence
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\CurrentVersion\\Run*"
          value_name: "Exela Update Service"
        
        # File hiding
        - type: "Process"
          op: "CommandLine"
          pattern: "*attrib*+h*+s*ExelaUpdateService*"
        
        # Startup folder
        - type: "File"
          op: "Create"
          path_pattern: "*\\Startup\\Exela.exe"

    # ============================================================================
    # STAGE 16: Fake Error Dialog Pattern
    # ============================================================================
    - name: "Fake_DLL_Error_Social_Engineering"
      conditions:
        # mshta JavaScript popup (Line 1157)
        - type: "Process"
          op: "CommandLine"
          pattern: "*mshta*javascript*WScript.Shell*Popup*"
        
        # Specific DLL error message
        - type: "Process"
          op: "CommandLine"
          pattern: "*api-ms-win-crt-runtime*missing*"

  # --- Correlation Logic ---
  mapping:
    or:
      # High confidence: Unique identifiers + any credential theft
      - and:
          - stage: "Exela_Unique_Identifiers"
          - stage: "Python_Browser_Database_Theft"
      
      # High confidence: Python + Discord injection + webhook
      - and:
          - stage: "Python_Browser_Database_Theft"
          - stage: "Discord_Injection_Exela_Pattern"
          - stage: "Discord_Webhook_Exfiltration"
      
      # High confidence: UUID pattern + persistence + exfiltration
      - and:
          - stage: "UUID_Staging_Directory"
          - stage: "ExelaUpdateService_Persistence"
          - stage: "GoFile_Exfiltration"
      
      # Medium confidence: Anti-VM + browser theft + webhook
      - and:
          - stage: "UUID_Based_AntiVM_AntiDebug"
          - stage: "Python_Browser_Database_Theft"
          - stage: "Discord_Webhook_Exfiltration"
      
      # Medium confidence: Steam + social media + exfiltration
      - and:
          - stage: "Steam_API_Session_Theft"
          - stage: "Social_Media_API_Harvesting"
          - stage: "Discord_Webhook_Exfiltration"

  # --- Memory Scan Configuration ---
  memory_scan_config:
    target_processes: 
      - "python*"
      - "pythonw*"
      - "py.exe"
      - "*.exe"
    scan_on_io_event: false
    scan_every_n_ops: 100  # More frequent scanning for Python

  # --- Allowlisting ---
  allowlisted_apps:
    - pattern: "explorer.exe"
      must_be_signed: true
      signers: ["Microsoft Windows", "Microsoft Corporation"]
    
    - pattern: "chrome.exe"
      must_be_signed: true
      signers: ["Google LLC"]
    
    - pattern: "msedge.exe"
      must_be_signed: true
      signers: ["Microsoft Corporation"]
    
    - pattern: "firefox.exe"
      must_be_signed: true
      signers: ["Mozilla Corporation", "Mozilla Foundation"]

  # --- Response ---
  response:
    record: true
    terminate_process: true
    quarantine: true
    suspend_process: false
    auto_revert: true  # Revert file changes
  
  proximity_log_threshold: 60.0
  debug: true  # Enable detailed logging for Python processes
