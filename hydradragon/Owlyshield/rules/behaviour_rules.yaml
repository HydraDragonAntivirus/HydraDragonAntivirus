!include sandboxes.yaml
- name: "Unified Attack Pipeline Detection"
  description: "Detects HydraDragon Attack Pipeline including browser access, termination, and exfiltration staging."
  severity: 10
  time_window_ms: 30000
  min_stages_satisfied: 2
  conditions_percentage: 0.5
  stages:
    - name: "Sensitive Browser Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Google\\Chrome\\User Data*Cookies*"
            - "*Google\\Chrome\\User Data*Login Data*"
            - "*Google\\Chrome\\User Data*Web Data*"
            - "*Google\\Chrome\\User Data*Local State*"
            - "*Opera Software\\Opera Stable*Cookies*"
            - "*Opera Software\\Opera Stable*Login Data*"
            - "*Opera Software\\Opera Stable*Web Data*"
            - "*Opera Software\\Opera Stable*Local State*"
            - "*Opera Software\\Opera GX Stable*Cookies*"
            - "*Opera Software\\Opera GX Stable*Login Data*"
            - "*Opera Software\\Opera GX Stable*Web Data*"
            - "*Opera Software\\Opera GX Stable*Local State*"
            - "*Brave-Browser\\User Data*Cookies*"
            - "*Brave-Browser\\User Data*Login Data*"
            - "*BraveSoftware\\Brave-Browser\\User Data*Web Data*"
            - "*Microsoft\\Edge\\User Data*Cookies*"
            - "*Microsoft\\Edge\\User Data*Login Data*"
            - "*Discord\\Local Storage*"
            - "*Discord\\leveldb*"
          op_type: "Read"
          min_unique_paths: 3

    - name: "Browser Termination"
      conditions:
        - type: "Process"
          op: "Terminate"
          pattern: "chrome.exe|msedge.exe|brave.exe|opera.exe|discord.exe"

    - name: "Credential Decryption"
      conditions:
        - type: "Api"
          name_pattern: "CryptUnprotectData|BCryptDecrypt|NCryptDecrypt"
          module_pattern: "crypt32.dll|bcrypt.dll|ncrypt.dll"

    - name: "Data Staging & Archiving"
      conditions:
        - type: "File"
          op: "Write"
          path_pattern: "(?i)AppData\\\\Local\\\\Temp\\\\.*\\.(zip|rar|7z|tar)"
        - type: "Heuristic"
          metric: "Entropy"
          threshold: 7.0
        - type: "ExtensionPattern"
          patterns: ["*.zip", "*.rar", "*.7z", "*.tar"]
          op_type: "Write"

    - name: "Suspicious Parent"
      conditions:
        - type: "ProcessAncestry"
          ancestor_pattern: "(?i)(powershell|cmd|wscript|cscript|mshta|python|node)"

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_Exfiltration"
  allowlisted_apps:
    - "chrome.exe"
    - "msedge.exe"
    - "brave.exe"
    - "opera.exe"
    - "discord.exe"
    - "codium.exe"
    - "vscodium.exe"
    - "code.exe"
    - "visualstudio.exe"
    - "devenv.exe"
    - "WindowsPackageManagerServer.exe"

- name: "Tasia Malware Detection"
  description: "Detects Tasia malware kill-chain including critical system tool disablement, shell disruption, and utility hijacks."
  severity: 10
  mapping:
    and:
      - stage: "System Lockout & Persistence"
      - or:
          - stage: "UAC/Utility Hijack"
          - stage: "Shell Disruption"
  stages:
    - name: "System Lockout & Persistence"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableRegistryTools"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableTaskMgr"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableLockWorkstation"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableChangePassword"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\System"
          value_name: "DisableCMD"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer"
          value_name: "NoLogoff"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer"
          value_name: "NoClose"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "HideFastUserSwitching"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System"
          value_name: "DontDisplayNetworkSelectionUI"
          expected_data: "1"

    - name: "UAC/Utility Hijack"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\utilman.exe"
          value_name: "Debugger"

    - name: "Shell Disruption"
      conditions:
        - type: "Process"
          op: "Terminate"
          pattern: "explorer.exe"

  response:
    terminate_process: true
    quarantine: true

- name: "EDR Detection: SignatureMonster SDK (Enhanced)"
  description: "Detects the deep system fingerprinting and anti-analysis checks performed by the SignatureMonster SDK."
  severity: 8
  min_stages_satisfied: 2
  stages:
    - name: "Hardware & Environment Fingerprinting"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*(Win32_Processor|Win32_BIOS|Win32_BaseBoard|Win32_ComputerSystemProduct|Win32_DiskDrive|Win32_NetworkAdapterConfiguration|Win32_OperatingSystem)"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*(MachineGuid|ProductId|DisplayVersion|EditionID)"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*(LastBootUpTime|TotalSeconds|PrimaryScreen\\.Bounds|USBHub)"

    - name: "Anti-Analysis & Privilege Escalation"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)Add-Type.*MitigationPolicy|SetProcessMitigationPolicy|GetProcessMitigationPolicy"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)Add-Type.*MitigationCheck|IsMicrosoftSignedOnly"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)whoami /priv|IsInRole|Administrator"

    - name: "Suspicious API Activity (Fingerprinting)"
      conditions:
        - type: "Api"
          name_pattern: "GetFileAttributesW|FindFirstFileW|RegOpenKeyExW|RegQueryValueExW|GetFileSizeEx"
          module_pattern: "kernel32.dll|advapi32.dll"

  response:
    terminate_process: true
    signal_firewall: "Isolate_Process"

- name: "Super Aggressive Trojan Attack"
  description: "Detects rapid, broad-spectrum file scanning across multiple directories in a 5-second window."
  severity: 10
  time_window_ms: 5000
  stages:
    - name: "Aggressive Scanning"
      mapping:
        and:
          - stage: "High Volume Access"
          - stage: "Broad Directory Spread"
    - name: "High Volume Access"
      conditions:
        - type: "OperationCount"
          operation: "File_Open"
          threshold: 100
          time_window_ms: 5000
    - name: "Broad Directory Spread"
      conditions:
        - type: "DirectorySpread"
          category: "accessed"
          threshold: 20
          time_window_ms: 5000

  response:
    terminate_process: true
    quarantine: true
