!include sandboxes.yaml

# ============================================================================
# STEALER DETECTION RULES - Comprehensive Browser & Application Data Theft
# ============================================================================

- name: "Browser Data Stealer - Chrome Family"
  description: "Detects unauthorized access to Chrome/Chromium-based browser data including cookies, credentials, and payment info."
  severity: 9
  time_window_ms: 30000
  min_stages_satisfied: 2
  stages:
    - name: "Cookie & Credential Theft"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Google\\Chrome\\User Data*Cookies*"
            - "*Google\\Chrome\\User Data*Login Data*"
            - "*Google\\Chrome\\User Data*Web Data*"
            - "*Microsoft\\Edge\\User Data*Cookies*"
            - "*Microsoft\\Edge\\User Data*Login Data*"
            - "*BraveSoftware\\Brave-Browser\\User Data*Cookies*"
            - "*BraveSoftware\\Brave-Browser\\User Data*Login Data*"
            - "*Chromium\\User Data*Cookies*"
            - "*Chromium\\User Data*Login Data*"
          op_type: "Read"
          min_unique_paths: 2

    - name: "Payment & Autofill Data"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*\\User Data*Web Data*"
            - "*\\User Data*Autofill*"
            - "*\\User Data*Credit Cards*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Master Key Theft"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data*Local State*"

    - name: "Data Exfiltration Staging"
      conditions:
        - type: "TempDirectoryWrite"
          min_bytes: 10240
          min_files: 2
        - type: "ArchiveCreation"
          extensions: ["zip", "rar", "7z", "tar", "gz"]
          in_temp: true

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_Exfiltration"
  
  allowlisted_apps:
    - "chrome.exe"
    - "msedge.exe"
    - "brave.exe"
    - "GoogleUpdate.exe"

- name: "Browser Data Stealer - Firefox/Mozilla"
  description: "Detects theft of Firefox browser data including profiles, cookies, and stored credentials."
  severity: 9
  time_window_ms: 30000
  min_stages_satisfied: 2
  stages:
    - name: "Firefox Profile Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Mozilla\\Firefox\\Profiles*cookies.sqlite*"
            - "*Mozilla\\Firefox\\Profiles*logins.json*"
            - "*Mozilla\\Firefox\\Profiles*key4.db*"
            - "*Mozilla\\Firefox\\Profiles*places.sqlite*"
            - "*Mozilla\\Firefox\\Profiles*formhistory.sqlite*"
          op_type: "Read"
          min_unique_paths: 2

    - name: "Master Password Database"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*Mozilla\\Firefox\\Profiles*key3.db*"

    - name: "Profile Copy/Export"
      conditions:
        - type: "FileCount"
          category: "read"
          comparison: "gte"
          threshold: 5
        - type: "TempDirectoryWrite"
          min_files: 3

  response:
    terminate_process: true
    quarantine: true
  
  allowlisted_apps:
    - "firefox.exe"

- name: "Discord Token Stealer"
  description: "Detects unauthorized access to Discord authentication tokens and local storage."
  severity: 8
  time_window_ms: 20000
  min_stages_satisfied: 2
  stages:
    - name: "Token Database Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Discord\\Local Storage\\leveldb*"
            - "*Discord\\Local State*"
            - "*Discord\\Session Storage*"
            - "*DiscordCanary\\Local Storage\\leveldb*"
            - "*DiscordPTB\\Local Storage\\leveldb*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Token Extraction Pattern"
      conditions:
        - type: "ByteThreshold"
          direction: "read"
          comparison: "gte"
          threshold: 1024
        - type: "CommandLineMatch"
          patterns:
            - pattern: "leveldb"
              modifiers: ["nocase", "contains"]
          match_mode: "any"

    - name: "Network Exfiltration Indicator"
      conditions:
        - type: "Network"
          op: "Connect"
          dest_pattern: ".*"

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_Exfiltration"
  
  allowlisted_apps:
    - "Discord.exe"
    - "DiscordCanary.exe"
    - "DiscordPTB.exe"

- name: "Cryptocurrency Wallet Stealer"
  description: "Detects theft of cryptocurrency wallet data from various wallet applications."
  severity: 10
  time_window_ms: 30000
  min_stages_satisfied: 1
  stages:
    - name: "Wallet File Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Ethereum\\keystore*"
            - "*Electrum\\wallets*"
            - "*Bitcoin\\wallet.dat*"
            - "*Exodus\\exodus.wallet*"
            - "*Atomic\\Local Storage\\leveldb*"
            - "*Coinomi\\wallets*"
            - "*Jaxx\\Local Storage*"
            - "*MetaMask*"
            - "*.wallet*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Wallet Configuration Theft"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*wallet*.json|*keystore*|*.wallet"

    - name: "Data Staging"
      conditions:
        - type: "TempDirectoryWrite"
          min_bytes: 1024

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_All_Traffic"

- name: "Email Client Data Stealer"
  description: "Detects theft of email client data including Outlook, Thunderbird, and webmail credentials."
  severity: 8
  time_window_ms: 25000
  min_stages_satisfied: 2
  stages:
    - name: "Outlook Data Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Microsoft\\Outlook*\\*.pst"
            - "*Microsoft\\Outlook*\\*.ost"
            - "*Microsoft\\Outlook*\\Outlook.exe"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Thunderbird Profile"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Thunderbird\\Profiles*logins.json*"
            - "*Thunderbird\\Profiles*key4.db*"
            - "*Thunderbird\\Profiles*cert9.db*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Credential Decryption"
      conditions:
        - type: "Api"
          name_pattern: "CryptUnprotectData|BCryptDecrypt"
          module_pattern: "crypt32.dll|bcrypt.dll"

  response:
    terminate_process: true
    quarantine: true

- name: "FTP Client Credential Stealer"
  description: "Detects theft of stored FTP credentials from FileZilla, WinSCP, and other FTP clients."
  severity: 7
  time_window_ms: 20000
  min_stages_satisfied: 1
  stages:
    - name: "FTP Configuration Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*FileZilla*recentservers.xml*"
            - "*FileZilla*sitemanager.xml*"
            - "*WinSCP.ini*"
            - "*CoreFTP\\sites.idx*"
            - "*FTP Navigator\\Ftplist.txt*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Credential File Copy"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "(?i).*(sitemanager|recentservers|winscp\\.ini|sites\\.idx).*"

  response:
    terminate_process: true
    quarantine: true

- name: "Gaming Platform Stealer"
  description: "Detects theft of gaming platform credentials and session tokens (Steam, Epic, etc.)."
  severity: 7
  time_window_ms: 30000
  min_stages_satisfied: 1
  stages:
    - name: "Steam Data Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Steam\\config\\loginusers.vdf*"
            - "*Steam\\ssfn*"
            - "*Steam\\config\\config.vdf*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Epic Games Tokens"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Epic\\EpicGamesLauncher\\Saved\\Config*"
            - "*Epic\\UnrealEngineLauncher\\Saved\\Config*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Gaming Session Files"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "(?i).*(loginusers\\.vdf|ssfn|epicgames).*"

  response:
    terminate_process: true
    quarantine: true

- name: "Credential Dumping via DPAPI"
  description: "Detects mass credential extraction using Windows DPAPI decryption."
  severity: 9
  time_window_ms: 15000
  min_stages_satisfied: 2
  stages:
    - name: "DPAPI Blob Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*\\Microsoft\\Protect\\*"
            - "*\\Credentials\\*"
            - "*\\Vault\\*"
          op_type: "Read"
          min_unique_paths: 2

    - name: "Mass Decryption Activity"
      conditions:
        - type: "Api"
          name_pattern: "CryptUnprotectData"
          module_pattern: "crypt32.dll"
        - type: "OperationCount"
          op_type: "Read"
          comparison: "gte"
          threshold: 10

    - name: "High-Speed Data Read"
      conditions:
        - type: "RateOfChange"
          metric: "files_per_second"
          comparison: "gte"
          threshold: 5.0

  response:
    terminate_process: true
    quarantine: true

- name: "Clipboard History Stealer"
  description: "Detects access to Windows clipboard history and stored clipboard data."
  severity: 6
  time_window_ms: 20000
  min_stages_satisfied: 1
  stages:
    - name: "Clipboard Data Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Microsoft\\Windows\\Clipboard*"
            - "*ClipboardHistory_*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "API Clipboard Access"
      conditions:
        - type: "Api"
          name_pattern: "GetClipboardData|OpenClipboard"
          module_pattern: "user32.dll"

  response:
    terminate_process: true

- name: "VPN Configuration Stealer"
  description: "Detects theft of VPN credentials and configuration files."
  severity: 7
  time_window_ms: 20000
  min_stages_satisfied: 1
  stages:
    - name: "VPN Config Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*OpenVPN\\config*"
            - "*NordVPN*"
            - "*ExpressVPN*"
            - "*ProtonVPN*"
            - "*.ovpn*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "VPN Credential Files"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "(?i).*\\.(ovpn|conf|vpn)$"

  response:
    terminate_process: true
    quarantine: true

- name: "SSH Key Stealer"
  description: "Detects theft of SSH private keys and known_hosts files."
  severity: 8
  time_window_ms: 15000
  min_stages_satisfied: 1
  stages:
    - name: "SSH Key Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*\\.ssh\\id_rsa*"
            - "*\\.ssh\\id_ed25519*"
            - "*\\.ssh\\id_ecdsa*"
            - "*\\.ssh\\known_hosts*"
            - "*\\.ssh\\config*"
          op_type: "Read"
          min_unique_paths: 1

    - name: "Private Key File Read"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "(?i).*\\.ssh\\\\(id_rsa|id_ed25519|id_ecdsa).*"

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_SSH_Traffic"

# ============================================================================
# GENERIC STEALER BEHAVIORAL PATTERNS
# ============================================================================

- name: "Mass Browser Data Harvesting"
  description: "Detects rapid access to multiple browser data files across different browsers."
  severity: 9
  time_window_ms: 20000
  min_stages_satisfied: 2
  stages:
    - name: "Multi-Browser Access"
      conditions:
        - type: "FileCount"
          category: "read"
          comparison: "gte"
          threshold: 10
        - type: "DirectorySpread"
          category: "opened"
          comparison: "gte"
          threshold: 5

    - name: "Sensitive Path Patterns"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*\\User Data*"
            - "*\\Profiles*"
            - "*\\Local Storage*"
            - "*Cookies*"
            - "*Login Data*"
          op_type: "Read"
          min_unique_paths: 5

    - name: "Rapid File Reading"
      conditions:
        - type: "RateOfChange"
          metric: "files_per_second"
          comparison: "gte"
          threshold: 3.0

  response:
    terminate_process: true
    quarantine: true

- name: "Stealer Archive Creation"
  description: "Detects creation of archives in temp directories with high entropy content (packed stolen data)."
  severity: 8
  time_window_ms: 25000
  min_stages_satisfied: 2
  stages:
    - name: "Temp Archive Creation"
      conditions:
        - type: "ArchiveCreation"
          extensions: ["zip", "rar", "7z", "tar", "gz", "bz2"]
          min_size: 5120
          in_temp: true

    - name: "High Entropy Content"
      conditions:
        - type: "EntropyThreshold"
          metric: "average"
          comparison: "gte"
          threshold: 6.5

    - name: "Rapid Data Staging"
      conditions:
        - type: "TempDirectoryWrite"
          min_bytes: 10240
          min_files: 3

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_Exfiltration"

- name: "Data Exfiltration via Network"
  description: "Detects combination of sensitive file access followed by network connectivity."
  severity: 9
  time_window_ms: 30000
  min_stages_satisfied: 3
  stages:
    - name: "Sensitive Data Access"
      conditions:
        - type: "FileCount"
          category: "read"
          comparison: "gte"
          threshold: 5

    - name: "Data Staging"
      conditions:
        - type: "TempDirectoryWrite"
          min_bytes: 1024

    - name: "Network Activity"
      conditions:
        - type: "Network"
          op: "Connect"

    - name: "Suspicious Parent Process"
      conditions:
        - type: "ProcessAncestry"
          ancestor_pattern: "(?i)(powershell|cmd|wscript|cscript|python|node|rundll32)"

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_All_Traffic"

- name: "Browser Process Termination Before Theft"
  description: "Detects termination of browser processes followed by database file access (unlock for copying)."
  severity: 9
  time_window_ms: 15000
  min_stages_satisfied: 2
  stages:
    - name: "Browser Termination"
      conditions:
        - type: "Process"
          op: "Terminate"
          pattern: "(?i)(chrome|firefox|edge|brave|opera|vivaldi)\\.exe"

    - name: "Database File Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Cookies*"
            - "*Login Data*"
            - "*Web Data*"
            - "*cookies.sqlite*"
            - "*logins.json*"
          op_type: "Read"
          min_unique_paths: 2

  response:
    terminate_process: true
    quarantine: true

  allowlisted_apps:
    - "chrome.exe"
    - "firefox.exe"
    - "msedge.exe"
    - "brave.exe"
    - "opera.exe"

# ============================================================================
# EXISTING RULES (Enhanced)
# ============================================================================

- name: "Unified Attack Pipeline Detection"
  description: "Detects HydraDragon Attack Pipeline including browser access, termination, and exfiltration staging."
  severity: 10
  time_window_ms: 30000
  min_stages_satisfied: 2
  conditions_percentage: 0.5
  stages:
    - name: "Sensitive Browser Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns:
            - "*Google\\Chrome\\User Data*Cookies*"
            - "*Google\\Chrome\\User Data*Login Data*"
            - "*Google\\Chrome\\User Data*Web Data*"
            - "*Google\\Chrome\\User Data*Local State*"
            - "*Opera Software\\Opera Stable*Cookies*"
            - "*Opera Software\\Opera Stable*Login Data*"
            - "*Opera Software\\Opera Stable*Web Data*"
            - "*Opera Software\\Opera Stable*Local State*"
            - "*Opera Software\\Opera GX Stable*Cookies*"
            - "*Opera Software\\Opera GX Stable*Login Data*"
            - "*Opera Software\\Opera GX Stable*Web Data*"
            - "*Opera Software\\Opera GX Stable*Local State*"
            - "*Brave-Browser\\User Data*Cookies*"
            - "*Brave-Browser\\User Data*Login Data*"
            - "*BraveSoftware\\Brave-Browser\\User Data*Web Data*"
            - "*Microsoft\\Edge\\User Data*Cookies*"
            - "*Microsoft\\Edge\\User Data*Login Data*"
            - "*Discord\\Local Storage*"
            - "*Discord\\leveldb*"
          op_type: "Read"
          min_unique_paths: 3

    - name: "Browser Termination"
      conditions:
        - type: "Process"
          op: "Terminate"
          pattern: "chrome.exe|msedge.exe|brave.exe|opera.exe|discord.exe"

    - name: "Credential Decryption"
      conditions:
        - type: "Api"
          name_pattern: "CryptUnprotectData|BCryptDecrypt|NCryptDecrypt"
          module_pattern: "crypt32.dll|bcrypt.dll|ncrypt.dll"

    - name: "Data Staging & Archiving"
      conditions:
        - type: "File"
          op: "Write"
          path_pattern: "(?i)AppData\\\\Local\\\\Temp\\\\.*\\.(zip|rar|7z|tar)"
        - type: "Heuristic"
          metric: "Entropy"
          threshold: 7.0
        - type: "ExtensionPattern"
          patterns: ["*.zip", "*.rar", "*.7z", "*.tar"]
          op_type: "Write"

    - name: "Suspicious Parent"
      conditions:
        - type: "ProcessAncestry"
          ancestor_pattern: "(?i)(powershell|cmd|wscript|cscript|mshta|python|node)"

  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_Exfiltration"
  allowlisted_apps:
    - "chrome.exe"
    - "msedge.exe"
    - "brave.exe"
    - "opera.exe"
    - "discord.exe"
    - "codium.exe"
    - "vscodium.exe"
    - "code.exe"
    - "visualstudio.exe"
    - "devenv.exe"
    - "WindowsPackageManagerServer.exe"

- name: "Tasia Malware Detection"
  description: "Detects Tasia malware kill-chain including critical system tool disablement, shell disruption, and utility hijacks."
  severity: 10
  mapping:
    and:
      - stage: "System Lockout & Persistence"
      - or:
          - stage: "UAC/Utility Hijack"
          - stage: "Shell Disruption"
  stages:
    - name: "System Lockout & Persistence"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableRegistryTools"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableTaskMgr"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableLockWorkstation"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "DisableChangePassword"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows\\\\System"
          value_name: "DisableCMD"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer"
          value_name: "NoLogoff"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer"
          value_name: "NoClose"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System"
          value_name: "HideFastUserSwitching"
          expected_data: "1"
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System"
          value_name: "DontDisplayNetworkSelectionUI"
          expected_data: "1"

    - name: "UAC/Utility Hijack"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: ".*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\utilman.exe"
          value_name: "Debugger"

    - name: "Shell Disruption"
      conditions:
        - type: "Process"
          op: "Terminate"
          pattern: "explorer.exe"

  response:
    terminate_process: true
    quarantine: true

- name: "EDR Detection: SignatureMonster SDK (Enhanced)"
  description: "Detects the deep system fingerprinting and anti-analysis checks performed by the SignatureMonster SDK."
  severity: 8
  min_stages_satisfied: 2
  stages:
    - name: "Hardware & Environment Fingerprinting"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*(Win32_Processor|Win32_BIOS|Win32_BaseBoard|Win32_ComputerSystemProduct|Win32_DiskDrive|Win32_NetworkAdapterConfiguration|Win32_OperatingSystem)"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*(MachineGuid|ProductId|DisplayVersion|EditionID)"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*(LastBootUpTime|TotalSeconds|PrimaryScreen\\.Bounds|USBHub)"

    - name: "Anti-Analysis & Privilege Escalation"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)Add-Type.*MitigationPolicy|SetProcessMitigationPolicy|GetProcessMitigationPolicy"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)Add-Type.*MitigationCheck|IsMicrosoftSignedOnly"
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)whoami /priv|IsInRole|Administrator"

    - name: "Suspicious API Activity (Fingerprinting)"
      conditions:
        - type: "Api"
          name_pattern: "GetFileAttributesW|FindFirstFileW|RegOpenKeyExW|RegQueryValueExW|GetFileSizeEx"
          module_pattern: "kernel32.dll|advapi32.dll"

  response:
    terminate_process: true
    signal_firewall: "Isolate_Process"

- name: "Super Aggressive Trojan Attack"
  description: "Detects rapid, broad-spectrum file scanning across multiple directories in a 5-second window."
  severity: 10
  time_window_ms: 5000
  min_stages_satisfied: 2
  stages:
    - name: "High Volume Access"
      conditions:
        - type: "OperationCount"
          op_type: "Read"
          comparison: "gte"
          threshold: 100

    - name: "Broad Directory Spread"
      conditions:
        - type: "DirectorySpread"
          category: "opened"
          comparison: "gte"
          threshold: 20

  response:
    terminate_process: true
    quarantine: true
