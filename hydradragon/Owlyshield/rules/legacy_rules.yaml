- name: "Unified_Browser_Credential_Stealer_Detection"
  description: "Multi-stage detection for browser credential theft: Access -> Collection -> Staging -> Exfiltration with advanced signature validation"
  
  # --- Metadata ---
  author: "Security Research Team"
  severity: 90
  level: critical
  status: stable
  
  mitre_attack:
    - "T1555.003"  # Credentials from Web Browsers
    - "T1074.001"  # Data Staged: Local Data Staging
    - "T1560"      # Archive Collected Data
    - "T1041"      # Exfiltration Over C2 Channel
    - "T1005"      # Data from Local System
  
  tags:
    - "credential_theft"
    - "browser_stealer"
    - "data_exfiltration"
  
  # --- Legacy Stealer Logic Support ---
  browser_paths:
    - "Google\\Chrome\\User Data"
    - "Microsoft\\Edge\\User Data"
    - "BraveSoftware\\Brave-Browser\\User Data"
    - "Opera Software\\Opera Stable"
    - "Mozilla\\Firefox\\Profiles"
    - "Discord\\Local Storage"
    - "Vivaldi\\User Data"
    - "Yandex\\YandexBrowser\\User Data"
  
  sensitive_files:
    - "Login Data"
    - "Cookies"
    - "Web Data"
    - "Local State"
    - "cookies.sqlite"
    - "logins.json"
    - "key4.db"
  
  staging_paths:
    - "AppData\\Local\\Temp"
    - "ProgramData"
    - "Temp"
  
  # --- Stage Correlation Configuration ---
  min_stages_satisfied: 2
  time_window_ms: 120000  # 2 minutes correlation window
  conditions_percentage: 0.30
  
  # Python processes get immediate memory scans
  record_on_start:
    - "python.exe"
    - "pythonw.exe"
    - "python3.exe"
  
  stages:
    # ========================================================================
    # STAGE 1: Sensitive Browser Data Access
    # ========================================================================
    - name: "Browser_Credential_Database_Access"
      conditions:
        # Reading Login Data databases
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\*\\Login Data"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\*\\Cookies"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Profiles\\*\\cookies.sqlite"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Profiles\\*\\logins.json"
        
        # Reading browser encryption keys
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\Local State"
        
        # High entropy read operations (encrypted credential data)
        - type: "Heuristic"
          metric: "Entropy"
          threshold: 6.5
        
        # Accessing multiple browser profiles
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 3
          patterns:
            - "*\\Google\\Chrome\\User Data\\*"
            - "*\\Microsoft\\Edge\\User Data\\*"
            - "*\\BraveSoftware\\Brave-Browser\\User Data\\*"
            - "*\\Opera Software\\Opera*\\*"
            - "*\\Mozilla\\Firefox\\Profiles\\*"
        
        # Memory: Browser decryption APIs
        - type: "MemoryScan"
          patterns:
            - "CryptUnprotectData"
            - "os_crypt"
            - "encrypted_key"
          detect_pe_headers: false
          private_only: false

    # ========================================================================
    # STAGE 2: Credential Decryption and Collection
    # ========================================================================
    - name: "Credential_Decryption_Processing"
      conditions:
        # Windows DPAPI usage
        - type: "MemoryScan"
          patterns:
            - "CryptUnprotectData"
            - "Crypt32"
            - "DPAPI"
          detect_pe_headers: false
          private_only: false
        
        # Chrome/Chromium decryption patterns
        - type: "MemoryScan"
          patterns:
            - "v10"
            - "v11"
            - "v20"
            - "AES"
            - "GCM"
          detect_pe_headers: false
          private_only: false
        
        # Creating temporary database copies
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*.db"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*.sqlite"
        
        # High volume of read operations
        - type: "FileCount"
          category: "read"
          comparison: "gte"
          threshold: 10

    # ========================================================================
    # STAGE 3: Data Staging and Organization
    # ========================================================================
    - name: "Stolen_Data_Staging"
      conditions:
        # Writing to temp directories
        - type: "TempDirectoryWrite"
          min_bytes: 10240  # 10KB minimum
          min_files: 3
        
        # Creating archive files
        - type: "ArchiveCreation"
          extensions: ["zip", "rar", "7z", "tar", "gz"]
          min_size: 5120  # 5KB minimum
          in_temp: true
        
        # Writing credential dump files
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\Passwords.txt"
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\Cookies.txt"
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*\\Autofill*.txt"
        
        # Extension patterns for staged data
        - type: "ExtensionPattern"
          op_type: "Write"
          match_mode: "any"
          patterns: 
            - "*.zip"
            - "*.tmp"
            - "*.dat"
            - "*.txt"
        
        # High write volume
        - type: "ByteThreshold"
          direction: "write"
          comparison: "gte"
          threshold: 51200  # 50KB

    # ========================================================================
    # STAGE 4: Network Exfiltration
    # ========================================================================
    - name: "Data_Exfiltration_Network"
      conditions:
        # Active network connections
        - type: "Network"
          op: "Connect"
        
        # Significant data upload
        - type: "ByteThreshold"
          direction: "write"
          comparison: "gte"
          threshold: 102400  # 100KB
        
        # Known exfiltration endpoints
        - type: "Network"
          op: "Connect"
          dest_pattern: "*discord.com/api/webhooks/*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*api.telegram.org/bot*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*gofile.io*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*anonfiles.com*"
        
        # Upload-related memory patterns
        - type: "MemoryScan"
          patterns:
            - "webhook"
            - "uploadFile"
            - "multipart/form-data"
            - "Content-Disposition"
          detect_pe_headers: false
          private_only: false

  # --- Correlation Mapping ---
  mapping:
    or:
      # Critical: Credential decryption alone is highly suspicious
      - stage: "Credential_Decryption_Processing"
      
      # High confidence: Access + Staging + Exfiltration (full attack chain)
      - and:
          - stage: "Browser_Credential_Database_Access"
          - stage: "Stolen_Data_Staging"
          - stage: "Data_Exfiltration_Network"
      
      # High confidence: Access + Decryption + Staging
      - and:
          - stage: "Browser_Credential_Database_Access"
          - stage: "Credential_Decryption_Processing"
          - stage: "Stolen_Data_Staging"
      
      # Medium confidence: Decryption + Staging + Exfiltration
      - and:
          - stage: "Credential_Decryption_Processing"
          - stage: "Stolen_Data_Staging"
          - stage: "Data_Exfiltration_Network"

  # ========================================================================
  # ADVANCED SIGNATURE-BASED ALLOWLISTING
  # ========================================================================
  allowlisted_apps:
    # -----------------------------------------------------------------------
    # Legitimate Browsers (Complex signature validation)
    # -----------------------------------------------------------------------
    - pattern: "chrome.exe"
      must_be_signed: true
      signers:
        - "Google LLC"
        - "Google Inc"
    
    - pattern: "msedge.exe"
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
        - "Microsoft Windows"
    
    - pattern: "firefox.exe"
      must_be_signed: true
      signers:
        - "Mozilla Corporation"
        - "Mozilla Foundation"
    
    - pattern: "brave.exe"
      must_be_signed: true
      signers:
        - "Brave Software, Inc."
    
    - pattern: "opera.exe"
      must_be_signed: true
      signers:
        - "Opera Norway AS"
        - "Opera Software AS"
    
    - pattern: "vivaldi.exe"
      must_be_signed: true
      signers:
        - "Vivaldi Technologies AS"
    
    # -----------------------------------------------------------------------
    # System Processes (Strict Microsoft signatures)
    # -----------------------------------------------------------------------
    - pattern: "explorer.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "svchost.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "taskmgr.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "powershell.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "cmd.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    # -----------------------------------------------------------------------
    # Password Managers (Legitimate credential access)
    # -----------------------------------------------------------------------
    - pattern: "1Password.exe"
      must_be_signed: true
      signers:
        - "AgileBits Inc."
    
    - pattern: "KeePass.exe"
      must_be_signed: true
      signers:
        - "Dominik Reichl"
    
    - pattern: "Bitwarden.exe"
      must_be_signed: true
      signers:
        - "8bit Solutions LLC"
        - "Bitwarden Inc."
    
    - pattern: "LastPass.exe"
      must_be_signed: true
      signers:
        - "LogMeIn, Inc."
        - "LastPass"
    
    - pattern: "Dashlane.exe"
      must_be_signed: true
      signers:
        - "Dashlane SAS"
        - "Dashlane Inc."
    
    # -----------------------------------------------------------------------
    # Development Tools (May legitimately access browser data)
    # -----------------------------------------------------------------------
    - pattern: "code.exe"
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
    
    - pattern: "devenv.exe"  # Visual Studio
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
    
    - pattern: "pycharm64.exe"
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    - pattern: "idea64.exe"  # IntelliJ
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    - pattern: "rider64.exe"  # Rider
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    - pattern: "webstorm64.exe"
      must_be_signed: true
      signers:
        - "JetBrains s.r.o."
    
    # -----------------------------------------------------------------------
    # Security Software (Legitimate scanning of browser data)
    # -----------------------------------------------------------------------
    - pattern: "MsMpEng.exe"  # Windows Defender
      must_be_signed: true
      signers:
        - "Microsoft Windows"
        - "Microsoft Corporation"
    
    - pattern: "avp.exe"  # Kaspersky
      must_be_signed: true
      signers:
        - "AO Kaspersky Lab"
        - "Kaspersky Lab"
    
    - pattern: "avgnt.exe"  # Avira
      must_be_signed: true
      signers:
        - "Avira Operations GmbH & Co. KG"
    
    - pattern: "bdagent.exe"  # Bitdefender
      must_be_signed: true
      signers:
        - "BITDEFENDER SRL"
    
    - pattern: "NortonSecurity.exe"
      must_be_signed: true
      signers:
        - "Symantec Corporation"
        - "NortonLifeLock Inc."
    
    - pattern: "mcshield.exe"  # McAfee
      must_be_signed: true
      signers:
        - "McAfee, Inc."
        - "McAfee, LLC"
    
    # -----------------------------------------------------------------------
    # Backup Software (May access browser data for backup)
    # -----------------------------------------------------------------------
    - pattern: "Acronis.exe"
      must_be_signed: true
      signers:
        - "Acronis International GmbH"
    
    - pattern: "CrashPlan.exe"
      must_be_signed: true
      signers:
        - "Code42 Software, Inc."
    
    - pattern: "SyncBackPro.exe"
      must_be_signed: true
      signers:
        - "2BrightSparks Pte Ltd"
    
    # -----------------------------------------------------------------------
    # Cloud Sync Services (May access local files)
    # -----------------------------------------------------------------------
    - pattern: "Dropbox.exe"
      must_be_signed: true
      signers:
        - "Dropbox, Inc."
    
    - pattern: "GoogleDrive.exe"
      must_be_signed: true
      signers:
        - "Google LLC"
    
    - pattern: "OneDrive.exe"
      must_be_signed: true
      signers:
        - "Microsoft Corporation"
    
    - pattern: "Nextcloud.exe"
      must_be_signed: true
      signers:
        - "Nextcloud GmbH"
    
    # -----------------------------------------------------------------------
    # Browser Extensions/Helper Processes
    # -----------------------------------------------------------------------
    - pattern: "nacl64.exe"  # Chrome Native Client
      must_be_signed: true
      signers:
        - "Google LLC"
    
    - pattern: "elevation_service.exe"  # Chrome elevation
      must_be_signed: true
      signers:
        - "Google LLC"
    
    - pattern: "plugin-container.exe"  # Firefox plugins
      must_be_signed: true
      signers:
        - "Mozilla Corporation"
    
    # -----------------------------------------------------------------------
    # System Utilities (Signed by Microsoft or verified vendors)
    # -----------------------------------------------------------------------
    - pattern: "robocopy.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
    
    - pattern: "xcopy.exe"
      must_be_signed: true
      signers:
        - "Microsoft Windows"
    
    - pattern: "7z.exe"
      must_be_signed: true
      signers:
        - "Igor Pavlov"
    
    - pattern: "WinRAR.exe"
      must_be_signed: true
      signers:
        - "Alexander Roshal"
        - "win.rar GmbH"

  # ========================================================================
  # Memory Scan Configuration
  # ========================================================================
  memory_scan_config:
    target_processes:
      - "*python*"
      - "*"
    scan_on_io_event: true
    scan_every_n_ops: 5
    min_scan_interval_secs: 10

  # ========================================================================
  # Response Actions
  # ========================================================================
  response:
    record: true              # Enable detailed logging
    terminate_process: true   # Kill the malicious process
    quarantine: true          # Move executable to quarantine
    suspend_process: false    # Don't just suspend, terminate
    auto_revert: true         # Revert file changes if possible
  
  proximity_log_threshold: 70.0
  debug: false

# ============================================================================
# NEW GENERIC DETECTION RULES
# ============================================================================

- name: "Generic_System_Reconnaissance"
  description: "Detects processes executing multiple system reconnaissance commands in a single command line or in rapid succession. Common in stealers like Exela."
  severity: 70
  level: medium
  status: stable
  
  mitre_attack:
    - "T1082"  # System Information Discovery
    - "T1016"  # System Network Configuration Discovery
    - "T1087"  # Account Discovery
    - "T1057"  # Process Discovery

  tags: ["recon", "stealer", "discovery"]

  stages:
    - name: "Mass_Recon_OneLiner"
      conditions:
        - type: "CommandLineMatch"
          match_mode: "at_least"
          match_count: 2
          patterns:
            - pattern: "systeminfo"
              modifiers: ["nocase", "contains"]
            - pattern: "ipconfig"
              modifiers: ["nocase", "contains"]
            - pattern: "net user"
              modifiers: ["nocase", "contains"]
            - pattern: "tasklist"
              modifiers: ["nocase", "contains"]
            - pattern: "net localgroup"
              modifiers: ["nocase", "contains"]
            - pattern: "whoami"
              modifiers: ["nocase", "contains"]
            - pattern: "wmic"
              modifiers: ["nocase", "contains"]

  response:
    record: true
    terminate_process: true
    quarantine: false


- name: "Generic_Stealer_Discord_Token_Hunt"
  description: "Detects processes attempting to harvest Discord tokens by reading LevelDB files."
  severity: 85
  level: high
  status: stable

  mitre_attack:
    - "T1555.003" # Credentials from Web Browsers (often applies to Discord too)

  tags: ["stealer", "discord", "token_theft"]

  stages:
    - name: "Discord_DB_Access"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*\\Discord*\\Local Storage\\leveldb\\*.ldb"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Discord*\\Local Storage\\leveldb\\*.log"

  response:
    record: true
    terminate_process: true
    quarantine: true
    auto_revert: false


- name: "Generic_Stealer_Wallet_Hunt"
  description: "Detects processes accessing known cryptocurrency wallet files and browser extensions."
  severity: 80
  level: high
  status: stable

  mitre_attack:
    - "T1005" # Data from Local System

  tags: ["stealer", "crypto", "wallet"]

  stages:
    - name: "Wallet_File_Access"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "*\\wallet.dat"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\AppData\\Roaming\\Exodus\\exodus.wallet*"
          
        - type: "File"
          op: "Read"
          path_pattern: "*\\AppData\\Roaming\\Electrum\\wallets*"
          
        - type: "File"
          op: "Read"
          path_pattern: "*\\AppData\\Roaming\\Atomic\\Local Storage\\leveldb*"
          
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 1
          patterns:
            # Common Browser Extension IDs for Wallets (Metamask, Phantom, etc)
            - "*\\Local Extension Settings\\nkbihfbeogaeaoehlefnkodbefgpgknn*" # Metamask
            - "*\\Local Extension Settings\\bfnaelmomeimhlpmgjnjophhpkkoljpa*" # Phantom
            - "*\\Local Extension Settings\\fhbohimaelbohpjbbldcngcnapndodjp*" # Binance

  response:
    record: true
    terminate_process: true
    quarantine: true


- name: "Generic_Browser_Process_Termination"
  description: "Detects attempts to kill browser processes (Chrome, Edge, Firefox), a common tactic used by stealers to unlock database files for reading."
  severity: 60
  level: medium
  status: stable

  mitre_attack:
    - "T1489" # Service Stop (applied to processes)

  tags: ["evasion", "stealer", "interruption"]

  stages:
    - name: "Browser_Kill_Attempt"
      conditions:
        - type: "Process"
          op: "Spawn"
          pattern: "taskkill"
          
        - type: "CommandLineMatch"
          match_mode: "any"
          patterns:
            - pattern: "chrome"
              modifiers: ["nocase", "contains"]
            - pattern: "firefox"
              modifiers: ["nocase", "contains"]
            - pattern: "brave"
              modifiers: ["nocase", "contains"]
            - pattern: "opera"
              modifiers: ["nocase", "contains"]
            - pattern: "msedge"
              modifiers: ["nocase", "contains"]

  # Correlation: Require both conditions (Taskkill spawned + browser argument)
  conditions_percentage: 1.0 
  
  response:
    record: true
    terminate_process: true
    suspend_process: false


- name: "Generic_Persistence_Creation"
  description: "Detects common persistence mechanisms: writing to Registry Run keys or Startup folder."
  severity: 75
  level: high
  status: stable

  mitre_attack:
    - "T1547.001" # Registry Run Keys / Startup Folder

  tags: ["persistence", "registry", "startup"]

  stages:
    - name: "Persistence_Write"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\CurrentVersion\\Run\\*"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*.exe"
          
        - type: "File"
          op: "Create"
          path_pattern: "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*.bat"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*.vbs"

  response:
    record: true
    terminate_process: true
    auto_revert: true


- name: "Generic_Hidden_File_Creation"
  description: "Detects processes attempting to hide files using the 'attrib' command with hidden/system flags."
  severity: 50
  level: low
  status: stable

  mitre_attack:
    - "T1564.001" # Hidden Files and Directories

  tags: ["defense_evasion", "hiding"]

  stages:
    - name: "Attrib_Hiding"
      conditions:
        - type: "Process"
          op: "Spawn"
          pattern: "attrib"
          
        - type: "CommandLineMatch"
          match_mode: "all"
          patterns:
            - pattern: "+h"
              modifiers: ["nocase", "contains"]
            - pattern: "+s"
              modifiers: ["nocase", "contains"]

  conditions_percentage: 1.0
  
  response:
    record: true
    terminate_process: false # Only log/record for this, as legitimate installers might do it
