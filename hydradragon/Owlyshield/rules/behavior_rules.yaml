- name: "HEUR:Win64.PSW.Stealer.BehavesLike.Exela.gen"
  debug: true
  severity: 90
  level: critical
  
  # --- Advanced Tracking Options ---
  track_by_gid: true

  # --- Configuration for Staging Detection ---
  # Environment variables will be resolved by the engine (e.g., %TEMP%)
  staging_paths:
    - "%TEMP%"
    - "%APPDATA%\\Local\\Temp"
    - "%USERPROFILE%\\AppData\\Local\\Temp"
  
  # --- Sensitive Data Definitions ---
  # Required to populate 'stolen_file_reads' in engine for the check below
  accessed_paths:
    - "User Data"
    - "Login Data"
    - "Cookies"
    - "Web Data"
    - "Local State"
  
  # --- Stage Definitions ---
  stages:
    # 1. PREPARATION
    - name: "Preparation"
      conditions:
        - type: ProcessTermination
          name_pattern: "(chrome|msedge|brave|opera).exe"
          
    # 2. DISCOVERY
    - name: "Discovery"
      conditions:
        - type: File
          op: "read"
          path_pattern: ".*(Google|Opera|Brave|Microsoft|Discord).*(User Data|Stable|leveldb|Local Storage).*(Cookies|Login Data|Local State|Web Data).*"

    # 3. COLLECTION (Staging + Archiving Combined)
    # The pattern specifically looks for ARCHIVE files being written to TEMP
    # The engine enforces that prior Discovery MUST have occurred via require_prior_reads
    - name: "Collection"
      conditions:
        - type: File
          op: "write"
          path_pattern: ".*(Temp|AppData).*\\.(zip|rar|7z|tar)$"
          require_prior_reads: true

    # 4. EXFILTRATION
    - name: "Exfiltration"
      conditions:
        - type: Api
          name_pattern: "(InternetConnect|HttpSendRequest|InternetWriteFile|FtpPutFile|wsasend)"

  # Sequence enforcement
  mapping:
    sequence: 
      - "Preparation"
      - "Discovery"
      - "Collection"
      - "Exfiltration"

  # --- Behavioral Constraints ---
  multi_access_threshold: 2
  require_internet: true
  entropy_threshold: 7.0
  conditions_percentage: 1.0

  suspicious_parents:
    - "powershell.exe"
    - "cmd.exe"
    - "wscript.exe"
    - "cscript.exe"
    - "mshta.exe"
    - "python.exe"
    - "node.exe"
  
  file_actions:
    - "7z"
    - "tar"
  
  file_extensions:
    - ".zip"
    - ".rar"

  # --- Allowlists ---
  allowlisted_apps:
    - pattern: "chrome.exe"
      must_be_signed: true
      signers: ["Google.*"]
    - pattern: "msedge.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    - pattern: "brave.exe"
      must_be_signed: true
      signers: ["Brave Software.*"]
    - pattern: "opera.exe"
      must_be_signed: true
      signers: ["Opera.*"]
    - pattern: "discord.exe"
      must_be_signed: true
      signers: ["Discord.*"]
    - pattern: "code.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    - pattern: "visualstudio.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    - pattern: "devenv.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]

  # --- Response Actions ---
  response:
    terminate_process: true
    quarantine: true
    kill_and_remove: false
    auto_revert: true
    record: true
