# Main Behavior Rules with Recursive Inclusion and Boolean Logic

!include rules/sandboxes.yaml

- name: "Advanced Multi-Browser Stealer Detection"
  description: "Detects multi-stage browser credential theft spanning multiple browsers (Chrome, Edge, Firefox, Opera, Brave, Discord)."
  severity: 10
  time_window_ms: 60000
  mapping:
    and:
      - stage: "Sensitive Browser Access"
      - or:
          - stage: "Credential Decryption"
          - stage: "Data Staging"
  stages:
    - name: "Sensitive Browser Access"
      conditions:
        - type: "SensitivePathAccess"
          patterns: 
            - "*Google\\Chrome\\User Data*"
            - "*Microsoft\\Edge\\User Data*"
            - "*Mozilla\\Firefox\\Profiles*"
            - "*Opera Software\\Opera*"
            - "*Brave-Browser*"
            - "*discord\\local storage*"
          op_type: "Read"
          min_unique_paths: 3
    - name: "Credential Decryption"
      conditions:
        - type: "Api"
          name_pattern: "CryptUnprotectData|BCryptDecrypt"
          module_pattern: "crypt32.dll|bcrypt.dll"
    - name: "Data Staging"
      conditions:
        - type: "File"
          op: "Write"
          path_pattern: "(?i)AppData\\\\Local\\\\Temp\\\\.*\\.(zip|rar|7z|tar)"
        - type: "Heuristic"
          metric: "Entropy"
          threshold: 7.0
  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_Exfiltration"
  allowlisted_apps: ["chrome.exe", "msedge.exe", "discord.exe", "firefox.exe", "opera.exe", "brave.exe"]

- name: "Aggressive Trojan Persistence & Disability"
  description: "Detects tampering with security services and critical registry keys."
  severity: 9
  mapping:
    or:
      - stage: "Disable Security"
      - stage: "Service Tampering"
  stages:
    - name: "Disable Security"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows Defender"
          value_name: "DisableAntiSpyware"
          expected_data: "1"
    - name: "Service Tampering"
      conditions:
        - type: "Service"
          op: "Stop"
          name_pattern: "WinDefend"
  response:
    terminate_process: true
    auto_revert: true

- name: "EDR Detection: Signature Monster SDK"
  description: "Detects Signature Monster SDK anti-analysis checks via Boolean correlation."
  severity: 7
  mapping:
    or:
      - stage: "Hardware Identification Checks"
      - and:
          - stage: "Environment Fingerprinting"
          - or:
              - stage: "VMware Artifacts"
              - stage: "VirtualBox Artifacts"
  stages:
    - name: "Hardware Identification Checks"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*Get-CimInstance.*(Win32_Processor|Win32_BIOS|Win32_BaseBoard|Win32_ComputerSystemProduct)"
    - name: "Environment Fingerprinting"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*Get-ItemProperty.*(MachineGuid|ProductId|DisplayVersion)"
  response:
    terminate_process: true
    signal_firewall: "Isolate_Process"

- name: "Tasia Malware Detection"
  description: "Specific lockout and destruction patterns using Boolean logic."
  severity: 10
  mapping:
    and:
      - stage: "Lockout"
      - or:
          - stage: "UAC/Utility Hijack"
          - stage: "Shell Disruption"
  stages:
    - name: "Lockout"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"
          value_name: "DisableTaskMgr"
          expected_data: "1"
    - name: "UAC/Utility Hijack"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\utilman.exe"
          value_name: "Debugger"
    - name: "Shell Disruption"
      conditions:
        - type: "Process"
          op: "Terminate"
          pattern: "explorer.exe"
  response:
    terminate_process: true
    quarantine: true
