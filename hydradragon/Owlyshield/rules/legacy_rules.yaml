- name: "HEUR_Win64_Behavior_Universal_Stealer_Detection"
  description: |
    Advanced behavioral detection for information stealers (Python-based and native):
    - Detects PyInstaller/py2exe compiled stealers via DLL dependency analysis
    - Browser credential theft (Chrome, Firefox, Edge, Brave, Opera, Vivaldi)
    - Discord token injection and theft
    - Cryptocurrency wallet theft (Metamask, Exodus, Electrum, etc.)
    - Session hijacking (social media, gaming platforms)
    - Data staging and exfiltration patterns
    - Works for: Exela, RedLine, Raccoon, Vidar, Lumma, Mars, StealC, and variants
    
    Uses 70% behavioral correlation threshold with context-aware detection to minimize
    false positives while catching polymorphic/obfuscated stealers.
  
  # --- Metadata ---
  author: "Emirhan Ucan"
  date: "2025-01-20"
  severity: 95
  level: critical
  status: stable
  
  mitre_attack:
    - "T1555.003"    # Credentials from Web Browsers
    - "T1555.004"    # Credentials from Password Stores
    - "T1539"        # Steal Web Session Cookie
    - "T1005"        # Data from Local System
    - "T1074.001"    # Data Staged: Local Data Staging
    - "T1560.001"    # Archive Collected Data
    - "T1041"        # Exfiltration Over C2 Channel
    - "T1567.001"    # Exfiltration to Cloud Storage
    - "T1082"        # System Information Discovery
    - "T1497.001"    # Virtualization/Sandbox Evasion
    - "T1562.001"    # Impair Defenses: Disable or Modify Tools
    - "T1547.001"    # Boot or Logon Autostart Execution
    - "T1140"        # Deobfuscate/Decode Files or Information
  
  tags:
    - "infostealer"
    - "credential_theft"
    - "browser_stealer"
    - "discord_theft"
    - "crypto_theft"
    - "data_exfiltration"
    - "pyinstaller_malware"
    - "redline"
    - "raccoon"
    - "vidar"
    - "exela"
    - "lumma"
  
  false_positives:
    - "Legitimate password managers with proper signatures"
    - "Browser sync services (signed by browser vendors)"
    - "Backup software (signed by known vendors)"
    - "Development tools and debuggers"
  
  # --- Detection Thresholds ---
  # 70% of conditions must be satisfied across all stages
  conditions_percentage: 0.70
  
  # 20-minute correlation window
  time_window_ms: 1200000
  
  # --- Process Monitoring Strategy ---
  # Start recording ONLY when suspicious behavior is detected, not immediately
  record_on_start: []
  
  # --- Memory Scan Configuration ---
  # Only scan when suspicious behavior is observed (event-driven)
  # Targeting: Unsigned binaries, processes from temp/downloads, PyInstaller artifacts
  memory_scan_config:
    target_processes: []  # Empty = only scan when behavioral indicators trigger
    scan_on_io_event: false
    scan_every_n_ops: 5000  # Very high threshold - only scan after significant activity
    min_scan_interval_secs: 60  # 1-minute cooldown between scans
  
  # ============================================================================
  # DETECTION STAGES - BEHAVIORAL PATTERNS
  # ============================================================================
  
  stages:
    # ========================================================================
    # STAGE 1: PyInstaller/Py2exe Detection (DLL Dependencies)
    # ========================================================================
    - name: "Stage1_Python_Compiled_Binary"
      conditions:
        # PyInstaller runtime DLLs
        - type: "File"
          op: "Read"
          path_pattern: "*\\python*.dll"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\_MEI*\\python*.dll"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\_MEIPASS*\\*"
        
        # Py2exe artifacts
        - type: "File"
          op: "Read"
          path_pattern: "*\\library.zip"
        
        # PyInstaller unpacking behavior
        - type: "File"
          op: "Create"
          path_pattern: "*\\AppData\\Local\\Temp\\_MEI*\\*"
        
        # Python DLL loading from temp
        - type: "File"
          op: "Read"
          path_pattern: "*\\Temp\\*.pyd"
        
        # Memory signatures for Python runtime
        - type: "MemoryScan"
          patterns:
            - "PyInstaller"
            - "py2exe"
            - "python3.dll"
            - "python310.dll"
            - "python311.dll"
            - "python39.dll"
            - "_MEIPASS"
          detect_pe_headers: false
          private_only: true
    
    # ========================================================================
    # STAGE 2: Unsigned/Suspicious Executable
    # ========================================================================
    - name: "Stage2_Suspicious_Executable"
      conditions:
        # Unsigned or invalidly signed binary
        - type: "Signature"
          is_trusted: false
        
        # Running from suspicious locations
        - type: "Process"
          op: "Path"
          pattern: "*\\Temp\\*"
        
        - type: "Process"
          op: "Path"
          pattern: "*\\Downloads\\*"
        
        - type: "Process"
          op: "Path"
          pattern: "*\\AppData\\Local\\Temp\\*"
        
        - type: "Process"
          op: "Path"
          pattern: "*\\Users\\Public\\*"
    
    # ========================================================================
    # STAGE 3: Browser Database Access Pattern
    # ========================================================================
    - name: "Stage3_Browser_Database_Access"
      conditions:
        # Multiple browser credential databases accessed
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 3
          patterns:
            - "*\\Google\\Chrome\\User Data\\*\\Login Data"
            - "*\\Google\\Chrome\\User Data\\*\\Cookies"
            - "*\\Microsoft\\Edge\\User Data\\*\\Login Data"
            - "*\\Microsoft\\Edge\\User Data\\*\\Cookies"
            - "*\\BraveSoftware\\Brave-Browser\\User Data\\*\\Login Data"
            - "*\\Opera Software\\*\\Login Data"
            - "*\\Vivaldi\\User Data\\*\\Login Data"
            - "*\\Mozilla\\Firefox\\Profiles\\*\\cookies.sqlite"
            - "*\\Mozilla\\Firefox\\Profiles\\*\\logins.json"
            - "*\\Mozilla\\Firefox\\Profiles\\*\\key4.db"
        
        # Local State (DPAPI key)
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\Local State"
        
        # Web Data (autofill/cards)
        - type: "File"
          op: "Read"
          path_pattern: "*\\User Data\\*\\Web Data"
        
        # High volume browser file reads
        - type: "FileCount"
          category: "read"
          comparison: "gte"
          threshold: 10
    
    # ========================================================================
    # STAGE 4: Discord Token Theft
    # ========================================================================
    - name: "Stage4_Discord_Token_Theft"
      conditions:
        # Discord LevelDB access
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 2
          patterns:
            - "*\\Discord\\Local Storage\\leveldb\\*.ldb"
            - "*\\Discord\\Local Storage\\leveldb\\*.log"
            - "*\\discordcanary\\Local Storage\\leveldb\\*.ldb"
            - "*\\discordptb\\Local Storage\\leveldb\\*.ldb"
        
        # Discord core injection
        - type: "File"
          op: "Write"
          path_pattern: "*\\Discord\\*\\modules\\discord_desktop_core\\index.js"
        
        # Discord Local State
        - type: "File"
          op: "Read"
          path_pattern: "*\\Discord\\Local State"
    
    # ========================================================================
    # STAGE 5: Cryptocurrency Wallet Theft
    # ========================================================================
    - name: "Stage5_Crypto_Wallet_Theft"
      conditions:
        # Browser extension wallets
        - type: "SensitivePathAccess"
          op_type: "Read"
          min_unique_paths: 1
          patterns:
            - "*\\Local Extension Settings\\nkbihfbeogaeaoehlefnkodbefgpgknn\\*"  # Metamask
            - "*\\Local Extension Settings\\bfnaelmomeimhlpmgjnjophhpkkoljpa\\*"  # Phantom
            - "*\\Local Extension Settings\\fhbohimaelbohpjbbldcngcnapndodjp\\*"  # Binance
            - "*\\Local Extension Settings\\hnfanknocfeofbddgcijnmhnfnkdnaad\\*"  # Coinbase
            - "*\\Local Extension Settings\\egjidjbpglichdcondbcbdnbeeppgdph\\*"  # Trust
        
        # Desktop wallets
        - type: "File"
          op: "Read"
          path_pattern: "*\\Exodus\\exodus.wallet\\*"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Electrum\\wallets\\*"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\Atomic\\Local Storage\\leveldb\\*"
        
        - type: "File"
          op: "Read"
          path_pattern: "*\\wallet.dat"
    
    # ========================================================================
    # STAGE 6: Credential Decryption Indicators
    # ========================================================================
    - name: "Stage6_Credential_Decryption"
      conditions:
        # Temporary database copies
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*.db"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*.sqlite"
        
        # DPAPI access
        - type: "File"
          op: "Read"
          path_pattern: "*\\Microsoft\\Protect\\*"
        
        # High entropy data (encrypted/encoded)
        - type: "Heuristic"
          metric: "Entropy"
          threshold: 7.0
        
        # Many small database operations
        - type: "FileCount"
          category: "read"
          comparison: "gte"
          threshold: 20
    
    # ========================================================================
    # STAGE 7: Data Staging Pattern
    # ========================================================================
    - name: "Stage7_Data_Staging"
      conditions:
        # Temp directory writes
        - type: "TempDirectoryWrite"
          min_bytes: 8192
          min_files: 3
        
        # Organized credential files
        - type: "ExtensionPattern"
          op_type: "Write"
          match_mode:
            at_least: 2
          patterns:
            - "*.txt"
            - "*.log"
            - "*.dat"
            - "*.json"
        
        # Multiple file creation in temp
        - type: "FileCount"
          category: "created"
          comparison: "gte"
          threshold: 5
        
        # Suspicious filenames
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*password*"
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*cookie*"
        
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*autofill*"
    
    # ========================================================================
    # STAGE 8: Archive Creation
    # ========================================================================
    - name: "Stage8_Archive_Creation"
      conditions:
        # Archive creation in temp
        - type: "ArchiveCreation"
          extensions: ["zip", "rar", "7z", "tar"]
          min_size: 5120
          in_temp: true
        
        # Archive writes
        - type: "File"
          op: "Write"
          path_pattern: "*\\Temp\\*.zip"
        
        - type: "File"
          op: "Create"
          path_pattern: "*\\Temp\\*.zip"
    
    # ========================================================================
    # STAGE 9: Network Exfiltration
    # ========================================================================
    - name: "Stage9_Network_Exfiltration"
      conditions:
        # C2 connections
        - type: "Network"
          op: "Connect"
          dest_pattern: "*discord.com/api/webhooks/*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*api.telegram.org/bot*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*gofile.io*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*anonfiles.com*"
        
        - type: "Network"
          op: "Connect"
          dest_pattern: "*transfer.sh*"
        
        # General network activity with upload
        - type: "Network"
          op: "Connect"
        
        - type: "ByteThreshold"
          direction: "write"
          comparison: "gte"
          threshold: 51200
    
    # ========================================================================
    # STAGE 10: Anti-Analysis Behavior
    # ========================================================================
    - name: "Stage10_Anti_Analysis"
      conditions:
        # VM/Sandbox checks
        - type: "CommandLineMatch"
          match_mode:
            at_least: 2
          patterns:
            - pattern: "wmic"
              modifiers: ["nocase", "contains"]
            - pattern: "csproduct"
              modifiers: ["nocase", "contains"]
            - pattern: "uuid"
              modifiers: ["nocase", "contains"]
        
        # VM process termination
        - type: "Process"
          op: "Terminate"
          pattern: "(?i)(vbox|vmware|virt|qemu|xen)\\.exe"
        
        # Debugger detection
        - type: "Process"
          op: "Terminate"
          pattern: "(?i)(ollydbg|x64dbg|windbg|ida)\\.exe"
    
    # ========================================================================
    # STAGE 11: Browser Process Manipulation
    # ========================================================================
    - name: "Stage11_Browser_Process_Kill"
      conditions:
        # Browser termination to unlock databases
        - type: "CommandLineMatch"
          match_mode: "all"
          patterns:
            - pattern: "taskkill"
              modifiers: ["nocase", "contains"]
            - pattern: "/f"
              modifiers: ["nocase", "contains"]
        
        - type: "CommandLineMatch"
          match_mode:
            at_least: 1
          patterns:
            - pattern: "chrome"
              modifiers: ["nocase", "contains"]
            - pattern: "firefox"
              modifiers: ["nocase", "contains"]
            - pattern: "msedge"
              modifiers: ["nocase", "contains"]
    
    # ========================================================================
    # STAGE 12: Persistence Mechanisms
    # ========================================================================
    - name: "Stage12_Persistence"
      conditions:
        # Registry Run keys
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\CurrentVersion\\Run*"
        
        # Startup folder
        - type: "File"
          op: "Create"
          path_pattern: "*\\Start Menu\\Programs\\Startup\\*"
        
        # Scheduled tasks
        - type: "CommandLineMatch"
          match_mode: "all"
          patterns:
            - pattern: "schtasks"
              modifiers: ["nocase", "contains"]
            - pattern: "/create"
              modifiers: ["nocase", "contains"]
    
    # ========================================================================
    # STAGE 13: System Reconnaissance
    # ========================================================================
    - name: "Stage13_System_Recon"
      conditions:
        # System info gathering
        - type: "CommandLineMatch"
          match_mode:
            at_least: 3
          patterns:
            - pattern: "systeminfo"
              modifiers: ["nocase", "contains"]
            - pattern: "ipconfig"
              modifiers: ["nocase", "contains"]
            - pattern: "whoami"
              modifiers: ["nocase", "contains"]
            - pattern: "net user"
              modifiers: ["nocase", "contains"]
            - pattern: "query session"
              modifiers: ["nocase", "contains"]
    
    # ========================================================================
    # STAGE 14: Stealer-Specific Memory Signatures
    # ========================================================================
    - name: "Stage14_Stealer_Memory_Signatures"
      conditions:
        # Common stealer strings in memory
        - type: "MemoryScan"
          patterns:
            # Exela specific
            - "Exela | Stealer | on | Top"
            - "Exela Corporation"
            # RedLine specific
            - "RedLine.Reburn"
            - "RedLine Stealer"
            # Raccoon specific
            - "RC4Init"
            - "machineId"
            # Vidar specific
            - "Vidar"
            - "profile.ini"
            # Lumma specific
            - "LummaStealer"
            - "C2_URL"
            # Generic stealer patterns
            - "grab_passwords"
            - "grab_cookies"
            - "get_wallets"
            - "steal_tokens"
          detect_pe_headers: true
          private_only: true
  
  # ============================================================================
  # CORRELATION MAPPING - BEHAVIORAL CHAINS
  # ============================================================================
  # NOTE: Percentage threshold (70%) is checked FIRST before this mapping
  # This mapping provides the LOGICAL STRUCTURE after percentage is met
  
  mapping:
    or:
      # === VERY HIGH CONFIDENCE ===
      
      # 1. PyInstaller binary + browser theft + exfiltration
      - and:
          - stage: "Stage1_Python_Compiled_Binary"
          - stage: "Stage3_Browser_Database_Access"
          - stage: "Stage9_Network_Exfiltration"
      
      # 2. Stealer memory signature + behavioral context (not alone!)
      - and:
          - stage: "Stage14_Stealer_Memory_Signatures"
          - stage: "Stage2_Suspicious_Executable"
          - or:
              - stage: "Stage3_Browser_Database_Access"
              - stage: "Stage4_Discord_Token_Theft"
              - stage: "Stage7_Data_Staging"
      
      # 3. Complete exfiltration chain
      - and:
          - stage: "Stage2_Suspicious_Executable"
          - stage: "Stage3_Browser_Database_Access"
          - stage: "Stage7_Data_Staging"
          - stage: "Stage8_Archive_Creation"
          - stage: "Stage9_Network_Exfiltration"
      
      # === HIGH CONFIDENCE ===
      
      # 4. Unsigned binary + credential theft + staging + network
      - and:
          - stage: "Stage2_Suspicious_Executable"
          - or:
              - stage: "Stage3_Browser_Database_Access"
              - stage: "Stage4_Discord_Token_Theft"
              - stage: "Stage5_Crypto_Wallet_Theft"
          - stage: "Stage7_Data_Staging"
          - stage: "Stage9_Network_Exfiltration"
      
      # 5. Discord injection + staging + network
      - and:
          - stage: "Stage4_Discord_Token_Theft"
          - stage: "Stage7_Data_Staging"
          - stage: "Stage9_Network_Exfiltration"
      
      # 6. Crypto theft + staging + exfiltration
      - and:
          - stage: "Stage5_Crypto_Wallet_Theft"
          - stage: "Stage7_Data_Staging"
          - stage: "Stage9_Network_Exfiltration"
      
      # === MEDIUM CONFIDENCE ===
      
      # 7. Browser kill + credential theft + decryption + network
      - and:
          - stage: "Stage11_Browser_Process_Kill"
          - stage: "Stage3_Browser_Database_Access"
          - stage: "Stage6_Credential_Decryption"
          - stage: "Stage9_Network_Exfiltration"
      
      # 8. Anti-analysis + credential theft + staging + exfiltration
      - and:
          - stage: "Stage10_Anti_Analysis"
          - stage: "Stage3_Browser_Database_Access"
          - stage: "Stage7_Data_Staging"
          - stage: "Stage9_Network_Exfiltration"
      
      # 9. Multi-source theft + staging + network
      - and:
          - or:
              - stage: "Stage3_Browser_Database_Access"
              - stage: "Stage4_Discord_Token_Theft"
          - or:
              - stage: "Stage5_Crypto_Wallet_Theft"
              - stage: "Stage6_Credential_Decryption"
          - stage: "Stage7_Data_Staging"
          - stage: "Stage9_Network_Exfiltration"
  
  # ============================================================================
  # COMPREHENSIVE ALLOWLIST
  # ============================================================================
  
  allowlisted_apps:
    # --- Browsers (Legitimate credential access) ---
    - pattern: "chrome.exe"
      must_be_signed: true
      signers: ["Google.*"]
    
    - pattern: "msedge.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "firefox.exe"
      must_be_signed: true
      signers: ["Mozilla.*"]
    
    - pattern: "brave.exe"
      must_be_signed: true
      signers: ["Brave Software.*"]
    
    - pattern: "opera.exe"
      must_be_signed: true
      signers: ["Opera.*"]
    
    - pattern: "vivaldi.exe"
      must_be_signed: true
      signers: ["Vivaldi.*"]
    
    # --- System Processes ---
    - pattern: "explorer.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "svchost.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "taskmgr.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "cmd.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "powershell.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "wmic.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "conhost.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    # --- Password Managers ---
    - pattern: "1Password.exe"
      must_be_signed: true
      signers: ["AgileBits.*"]
    
    - pattern: "Bitwarden.exe"
      must_be_signed: true
      signers: [".*Bitwarden.*", "8bit Solutions.*"]
    
    - pattern: "KeePass.exe"
      must_be_signed: true
      signers: ["Dominik Reichl"]
    
    - pattern: "LastPass.exe"
      must_be_signed: true
      signers: ["LogMeIn.*", "LastPass.*"]
    
    - pattern: "Dashlane.exe"
      must_be_signed: true
      signers: ["Dashlane.*"]
    
    # --- Security Software ---
    - pattern: "MsMpEng.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "MpCmdRun.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "mbam.exe"
      must_be_signed: true
      signers: ["Malwarebytes.*"]
    
    - pattern: "avp.exe"
      must_be_signed: true
      signers: [".*Kaspersky.*"]
    
    - pattern: "bdagent.exe"
      must_be_signed: true
      signers: ["BITDEFENDER.*"]
    
    # --- Development Tools ---
    - pattern: "code.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "devenv.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "pycharm*.exe"
      must_be_signed: true
      signers: ["JetBrains.*"]
    
    - pattern: "idea*.exe"
      must_be_signed: true
      signers: ["JetBrains.*"]
    
    # --- Backup Software ---
    - pattern: "Acronis*.exe"
      must_be_signed: true
      signers: ["Acronis.*"]
    
    - pattern: "Veeam*.exe"
      must_be_signed: true
      signers: ["Veeam.*"]
    
    # --- Cloud Sync ---
    - pattern: "Dropbox.exe"
      must_be_signed: true
      signers: ["Dropbox.*"]
    
    - pattern: "OneDrive.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    
    - pattern: "GoogleDrive*.exe"
      must_be_signed: true
      signers: ["Google.*"]
    
    # --- Communication Apps ---
    - pattern: "Discord.exe"
      must_be_signed: true
      signers: ["Discord.*"]
    
    - pattern: "Slack.exe"
      must_be_signed: true
      signers: ["Slack.*"]
    
    - pattern: "Teams.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
  
  # ============================================================================
  # RESPONSE CONFIGURATION
  # ============================================================================
  
  response:
    record: true
    terminate_process: true
    quarantine: true
    suspend_process: false
    auto_revert: true
    kill_and_remove: false
  
  # Log near-misses at 75%
  proximity_log_threshold: 75.0
  
  # Enable debug to see percentage calculations
  debug: true
