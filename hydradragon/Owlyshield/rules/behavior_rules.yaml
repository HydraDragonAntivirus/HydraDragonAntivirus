- name: "HEUR:Win64.PSW.Stealer.BehavesLike.Exela.gen"
  debug: true
  severity: 90
  level: critical
  
  # --- Advanced Tracking Options ---
  # GID (Group ID) tracking enables correlation across multiple processes
  # This defeats advanced bypass where steps are split (e.g., proc A steals, proc B uploads)
  track_by_gid: true

  # --- Configuration for Staging Detection ---
  # Environment variables will be resolved by the engine (e.g., %TEMP%)
  staging_paths:
    - "%TEMP%"
    - "%APPDATA%\\Local\\Temp"
    - "%USERPROFILE%\\AppData\\Local\\Temp"
  
  # Allow staging detection even if no sensitive files were read beforehand.
  allow_isolated_staging: true

  # --- Stage Definitions (Unified Logic) ---
  stages:
    # 1. PREPARATION: Killing browsers to unlock DB files
    # Tracked via GID shared state to catch if helper process does this
    - name: "Preparation"
      conditions:
        - type: ProcessTermination
          name_pattern: "(chrome|msedge|brave|opera).exe"
          
    # 2. DISCOVERY: Reading sensitive user data
    - name: "Discovery"
      conditions:
        - type: File
          op: "read"
          path_pattern: ".*(Google|Opera|Brave|Microsoft|Discord).*(User Data|Stable|leveldb|Local Storage).*(Cookies|Login Data|Local State|Web Data).*"

    # 3. COLLECTION: Writing to temp folders
    # Engine verifies kernel write events to resolved env paths
    - name: "Collection"
      conditions:
        - type: File
          op: "write"
          path_pattern: ".*(Temp|AppData).*"

    # 4. EXFILTRATION: Sending data out via WinInet/Sockets
    # Specifically looks for upload activity AFTER collection
    - name: "Exfiltration"
      conditions:
        - type: Api
          name_pattern: "(InternetConnect|HttpSendRequest|InternetWriteFile|FtpPutFile|wsasend)"

  # Sequence enforcement: Preparation -> Discovery -> Collection -> Exfiltration
  mapping:
    sequence: 
      - "Preparation"
      - "Discovery"
      - "Collection"
      - "Exfiltration"

  # --- Behavioral Constraints ---
  multi_access_threshold: 2
  require_internet: true
  entropy_threshold: 7.0
  conditions_percentage: 1.0

  # Metadata for engine categorization
  suspicious_parents:
    - "powershell.exe"
    - "cmd.exe"
    - "wscript.exe"
    - "cscript.exe"
    - "mshta.exe"
    - "python.exe"
    - "node.exe"
  
  file_actions:
    - "7z"
    - "tar"
  
  file_extensions:
    - ".zip"
    - ".rar"

  # --- Allowlists ---
  allowlisted_apps:
    - pattern: "chrome.exe"
      must_be_signed: true
      signers: ["Google.*"]
    - pattern: "msedge.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    - pattern: "brave.exe"
      must_be_signed: true
      signers: ["Brave Software.*"]
    - pattern: "opera.exe"
      must_be_signed: true
      signers: ["Opera.*"]
    - pattern: "discord.exe"
      must_be_signed: true
      signers: ["Discord.*"]
    - pattern: "code.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    - pattern: "visualstudio.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]
    - pattern: "devenv.exe"
      must_be_signed: true
      signers: ["Microsoft.*"]

  # --- Response Actions ---
  response:
    terminate_process: true
    quarantine: true
    kill_and_remove: false
    auto_revert: true
    record: true
