# Main Behavior Rules with Modular Inclusion

!include rules/sandboxes.yaml

- name: "Unified Browser Stealer Detection"
  description: "Detects multi-stage browser credential theft using a generic attack timeline."
  severity: 10
  time_window_ms: 60000
  min_stages_satisfied: 2
  stages:
    - name: "Browser Access"
      conditions:
        - type: "File"
          op: "Read"
          path_pattern: "(?i)Google\\\\Chrome\\\\User Data.*(Cookies|Login Data|Local State)"
        - type: "File"
          op: "Read"
          path_pattern: "(?i)Opera Software\\\\Opera Stable.*(Cookies|Login Data)"
        - type: "File"
          op: "Read"
          path_pattern: "(?i)Discord\\\\Local Storage"
    - name: "Credential Decryption"
      conditions:
        - type: "Api"
          name_pattern: "CryptUnprotectData|BCryptDecrypt"
          module_pattern: "crypt32.dll|bcrypt.dll"
    - name: "Data Staging"
      conditions:
        - type: "File"
          op: "Write"
          path_pattern: "(?i)AppData\\\\Local\\\\Temp\\\\.*\\.(zip|rar|7z|tar)"
        - type: "Heuristic"
          metric: "Entropy"
          threshold: 7.0
  response:
    terminate_process: true
    quarantine: true
    signal_firewall: "Block_Exfiltration"
  allowlisted_apps: ["chrome.exe", "msedge.exe", "discord.exe"]

- name: "Aggressive Trojan Persistence & Disability"
  description: "Detects tampering with security services and critical registry keys."
  severity: 9
  min_stages_satisfied: 1
  stages:
    - name: "Disable Security"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "(?i)Software\\\\Policies\\\\Microsoft\\\\Windows Defender"
          value_name: "DisableAntiSpyware"
          expected_data: "1"
        - type: "Service"
          op: "Stop"
          name_pattern: "WinDefend"
  response:
    terminate_process: true
    auto_revert: true

- name: "EDR Detection: Signature Monster SDK"
  description: "Detects Signature Monster SDK anti-analysis checks via PowerShell CIM queries."
  severity: 7
  min_stages_satisfied: 1
  stages:
    - name: "Hardware Identification Checks"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*Get-CimInstance.*(Win32_Processor|Win32_BIOS|Win32_BaseBoard|Win32_ComputerSystemProduct)"
    - name: "Environment Fingerprinting"
      conditions:
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)powershell.*Get-ItemProperty.*(MachineGuid|ProductId|DisplayVersion)"
  response:
    terminate_process: true
    signal_firewall: "Isolate_Process"

- name: "Tasia Malware Detection"
  description: "Specific lockout and destruction patterns."
  severity: 10
  conditions_percentage: 0.1
  stages:
    - name: "Lockout"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "(?i)Policies\\\\System"
          value_name: "DisableTaskMgr"
          expected_data: "1"
    - name: "UAC/Utility Hijack"
      conditions:
        - type: "Registry"
          op: "SetValue"
          key_pattern: "(?i)Image File Execution Options\\\\utilman\\.exe"
          value_name: "Debugger"
    - name: "Shell Disruption"
      conditions:
        - type: "Process"
          op: "Terminate"
          pattern: "explorer.exe"
  response:
    terminate_process: true
    quarantine: true