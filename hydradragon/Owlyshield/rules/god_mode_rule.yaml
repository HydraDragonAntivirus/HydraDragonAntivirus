# ============================================================================
#    _____        __  __  ___        __      
#   / ___/__  ___/ / /  |/  /__  ___/ /__    
#  / (_ / _ \/ _  / / /|_/ / _ \/ _  / -_)   
#  \___/\___/\_,_/ /_/  /_/\___/\_,_/\__/_   
#   / _ \__ __/ /__ 
#  / , _/ // / / -_)
# /_/|_|\_,_/_/\__/ 
#
# HEUR/Win32/Trojan/GODMode/gen - Universal Trojan First-Move Detection
# Based on Dr.Web principle: All trojans make the first move
# ============================================================================

- name: "HEUR/Win32/Trojan/GODMode/gen"
  description: "Universal trojan detection based on first-move attack patterns. Detects 90%+ of trojans by identifying their initial system compromise behaviors including: initial execution vectors, privilege escalation attempts, defense evasion, credential access, persistence establishment, and C2 communication setup."
  author: "Emirhan Ucan"
  date: "2026-01-12"
  severity: 10
  status: stable
  level: critical
  
  # MITRE ATT&CK Coverage
  mitre_attack:
    - "T1055"    # Process Injection
    - "T1059"    # Command and Scripting Interpreter
    - "T1068"    # Exploitation for Privilege Escalation
    - "T1070"    # Indicator Removal
    - "T1078"    # Valid Accounts
    - "T1082"    # System Information Discovery
    - "T1083"    # File and Directory Discovery
    - "T1087"    # Account Discovery
    - "T1090"    # Proxy
    - "T1105"    # Ingress Tool Transfer
    - "T1106"    # Native API
    - "T1112"    # Modify Registry
    - "T1134"    # Access Token Manipulation
    - "T1140"    # Deobfuscate/Decode Files or Information
    - "T1190"    # Exploit Public-Facing Application
    - "T1204"    # User Execution
    - "T1543"    # Create or Modify System Process
    - "T1547"    # Boot or Logon Autostart Execution
    - "T1548"    # Abuse Elevation Control Mechanism
    - "T1552"    # Unsecured Credentials
    - "T1562"    # Impair Defenses
    - "T1563"    # Remote Service Session Hijacking
    - "T1566"    # Phishing
    - "T1574"    # Hijack Execution Flow
  
  tags:
    - "godmode"
    - "universal_detection"
    - "first_move"
    - "initial_access"
    - "privilege_escalation"
    - "defense_evasion"
    - "credential_access"
    - "discovery"
    - "lateral_movement"
    - "persistence"
    - "command_and_control"
  
  references:
    - "https://vms.drweb.com/virus/?i=4276269"
    - "Dr.Web: All trojans make the first move"
    - "YARA God Mode Rule by Florian Roth"
    - "Sigma God Mode Rule by Florian Roth"
  
  debug: false
  proximity_log_threshold: 20.0
  time_window_ms: 120000  # 2 minutes for initial attack sequence
  min_stages_satisfied: 3  # Need at least 3 attack stages
  
  # Complex attack chain mapping - detects various first-move patterns
  mapping:
    or:
      # Pattern 1: Classic Initial Compromise → Execution → Persistence
      - and:
          - stage: "Initial Execution Vector"
          - stage: "Suspicious Process Behavior"
          - or:
              - stage: "Persistence Establishment"
              - stage: "Defense Evasion"
      
      # Pattern 2: Exploitation → Privilege Escalation → Credential Theft
      - and:
          - stage: "Exploitation Indicators"
          - stage: "Privilege Escalation"
          - or:
              - stage: "Credential Access"
              - stage: "Security Tool Tampering"
      
      # Pattern 3: Reflective Loading → Memory Injection → C2 Communication
      - and:
          - stage: "Reflective Code Loading"
          - stage: "Process Injection Techniques"
          - stage: "Network C2 Patterns"
      
      # Pattern 4: PowerShell Abuse → Obfuscation → Payload Download
      - and:
          - stage: "PowerShell Attack Patterns"
          - stage: "Code Obfuscation"
          - or:
              - stage: "Remote Payload Download"
              - stage: "File Staging & Dropper"
      
      # Pattern 5: Office Macro → Scripting Engine → Lateral Movement Prep
      - and:
          - stage: "Office Document Exploitation"
          - stage: "Scripting Engine Abuse"
          - or:
              - stage: "Network Discovery"
              - stage: "System Reconnaissance"
      
      # Pattern 6: DLL Hijacking → API Hooking → Stealthy Execution
      - and:
          - stage: "DLL Hijacking & Side-Loading"
          - stage: "API Manipulation"
          - stage: "Anti-Analysis Techniques"
      
      # Pattern 7: Rootkit Behavior → Driver Installation → System Modification
      - and:
          - stage: "Rootkit Indicators"
          - stage: "Kernel-Level Operations"
          - stage: "Critical System Modification"
      
      # Pattern 8: Webshell → Remote Code Execution → Post-Exploitation
      - and:
          - stage: "Webshell Activity"
          - stage: "Remote Command Execution"
          - stage: "Post-Exploitation Activity"
      
      # Pattern 9: Unsigned + Sensitive Access + Network = High Risk
      - and:
          - stage: "Signature Verification Failure"
          - stage: "Sensitive Data Access"
          - stage: "Network C2 Patterns"
  
  stages:
    # ========================================================================
    # STAGE 1: INITIAL EXECUTION VECTORS
    # ========================================================================
    - name: "Initial Execution Vector"
      conditions:
        # Suspicious parent-child process relationships
        - type: "ProcessAncestry"
          ancestor_pattern: "(?i)(WinRAR|7zFM|WinZip|Archive|Extract|excel|winword|powerpnt|mspub|visio|outlook|acrord32|chrome|firefox|msedge|iexplore|opera|brave)\\.exe"
          max_depth: 2
        
        # Execution from suspicious locations
        - type: "Process"
          op: "Path"
          pattern: "(?i)(\\\\AppData\\\\(Local|Roaming)\\\\Temp|\\\\Users\\\\Public|\\\\ProgramData|\\\\Windows\\\\Temp|\\\\Temp\\\\[^\\\\]+\\\\|Downloads\\\\[^\\\\]+\\.exe|Desktop\\\\[^\\\\]+\\.exe)"
        
        # Double extension tricks
        - type: "File"
          op: "Open"
          path_pattern: "*.(pdf|doc|xls|jpg|png|txt|zip).exe"
        
        # Execution from archive contents
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(\\\\Rar[A-Z0-9]{5}\\\\|\\\\7z[A-Z0-9]{5}\\\\|\\\\Temp\\\\[0-9]+\\\\Setup\\.exe)"
        
        # Script-based execution chains
        - type: "Process"
          op: "Spawn"
          pattern: "(?i)(wscript|cscript|mshta|rundll32|regsvr32|msxsl|forfiles|pcalua|mavinject)\\.exe"
        
        # Living-off-the-land binary execution
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(bitsadmin.*\\/transfer|certutil.*(decode|urlcache)|regsvr32.*/s.*/i|mshta.*http|rundll32.*javascript|odbcconf.*/a)"

    # ========================================================================
    # STAGE 2: SUSPICIOUS PROCESS BEHAVIOR
    # ========================================================================
    - name: "Suspicious Process Behavior"
      conditions:
        # Suspicious command line patterns (from Sigma God Mode)
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)( -NoP | -W Hidden | -WindowStyle Hidden | -Enc | -EncodedCommand | -decode | /decode )"
        
        # Encoded PowerShell commands
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)( -e[ncodema]{0,6} (JAB|SUVYI|aWV4I|SQBFAFgA|aQBlAHgA|IAB|PAA|cgBlAG))"
        
        # PowerShell download patterns
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(downloadstring\\(|downloadfile\\(|DownloadData\\(|webclient|invoke-webrequest|iwr |curl .*http)"
        
        # Process injection indicators
        - type: "Api"
          name_pattern: "(?i)(VirtualAllocEx|WriteProcessMemory|CreateRemoteThread|NtCreateThreadEx|RtlCreateUserThread|QueueUserAPC)"
          module_pattern: "(?i)(kernel32|kernelbase|ntdll)\\.dll"
        
        # Suspicious WMI usage
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(wmic.*process.*call.*create|wmic.*os.*get|wmic.*computersystem)"
        
        # Task scheduler abuse
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(schtasks.*/create.*/tr.*(AppData|ProgramData|Temp|Public)|schtasks.*/create.*\\/sc.*minute)"
        
        # Service manipulation
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sc.*create.*binpath|sc.*config.*binpath|net.*user.*/add|net.*localgroup.*administrators.*/add)"
        
        # Casing obfuscation (from YARA God Mode)
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sEt-ItEM|sET-iteM|SeT-iTEM|sET  |SeT  |seT  )"

    # ========================================================================
    # STAGE 3: PERSISTENCE ESTABLISHMENT
    # ========================================================================
    - name: "Persistence Establishment"
      conditions:
        # Registry Run keys
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Microsoft\\Windows\\CurrentVersion\\Run*"
          value_name: null
        
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Microsoft\\Windows\\CurrentVersion\\RunOnce*"
          value_name: null
        
        # Startup folder
        - type: "File"
          op: "Create"
          path_pattern: "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*"
        
        # Service creation
        - type: "Registry"
          op: "Create"
          key_pattern: "*\\System\\CurrentControlSet\\Services\\*"
        
        # WMI event subscription
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(ActiveScriptEventConsumer|__EventFilter|__FilterToConsumerBinding)"
        
        # Scheduled task persistence
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\*"
        
        # DLL side-loading locations
        - type: "File"
          op: "Write"
          path_pattern: "*\\System32\\*.(dll|exe)"
        
        # UserInitMprLogonScript
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\UserInitMprLogonScript*"
        
        # Image File Execution Options (IFEO) hijacking
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Image File Execution Options\\*"
          value_name: "Debugger"

    # ========================================================================
    # STAGE 4: DEFENSE EVASION
    # ========================================================================
    - name: "Defense Evasion"
      conditions:
        # Security tool disabling
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Windows Defender\\*"
          value_name: "DisableAntiSpyware"
          expected_data: "1"
        
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Windows Defender\\Real-Time Protection*"
          value_name: "DisableRealtimeMonitoring"
          expected_data: "1"
        
        # Firewall manipulation
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(netsh.*firewall.*set.*disable|netsh.*advfirewall.*set.*off)"
        
        # Event log clearing
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(wevtutil.*cl |wevtutil.*clear-log|clear-eventlog)"
        
        # AMSI bypass patterns
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(AmsiScanBuffer|amsiInitFailed|Ams.*i.*Ini.*t.*Fail)"
        
        # ETW tampering
        - type: "Api"
          name_pattern: "(?i)(EtwEventWrite|EtwEventWriteString)"
          module_pattern: "(?i)ntdll\\.dll"
        
        # Process hollowing
        - type: "Api"
          name_pattern: "(?i)(NtUnmapViewOfSection|ZwUnmapViewOfSection)"
          module_pattern: "(?i)ntdll\\.dll"
        
        # Self-deletion attempts
        - type: "SelfModification"
          modification_type: "exe_deleted"
        
        # Timestomping
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(timestomp|/timestamp:|SetFileTime)"

    # ========================================================================
    # STAGE 5: PRIVILEGE ESCALATION
    # ========================================================================
    - name: "Privilege Escalation"
      conditions:
        # UAC bypass techniques
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\mscfile\\shell\\open\\command*"
        
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(eventvwr\\.exe|fodhelper\\.exe|computerdefaults\\.exe|sdclt\\.exe)"
        
        # Token manipulation
        - type: "Api"
          name_pattern: "(?i)(DuplicateTokenEx|ImpersonateLoggedOnUser|SetThreadToken)"
          module_pattern: "(?i)advapi32\\.dll"
        
        # SeDebugPrivilege abuse
        - type: "Api"
          name_pattern: "(?i)(AdjustTokenPrivileges|LookupPrivilegeValue)"
          module_pattern: "(?i)advapi32\\.dll"
        
        # Named pipe impersonation
        - type: "File"
          op: "Create"
          path_pattern: "*\\\\.\\pipe\\*"
        
        # Exploit patterns
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(juicy|potato|sweetpotato|printspoofer|godpotato)"
        
        # Parent PID spoofing
        - type: "Api"
          name_pattern: "(?i)(UpdateProcThreadAttribute|PROC_THREAD_ATTRIBUTE_PARENT_PROCESS)"
          module_pattern: "(?i)kernel32\\.dll"

    # ========================================================================
    # STAGE 6: CREDENTIAL ACCESS
    # ========================================================================
    - name: "Credential Access"
      conditions:
        # LSASS memory dumping
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(lsass.*dmp|lsass.*dump| -ma .*lsass|comsvcs.*MiniDump|comsvcs.*#24)"
        
        # Mimikatz indicators (from YARA God Mode)
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sekurlsa::logonpasswords|sekurlsa::tickets|lsadump::sam|lsadump::secrets| p::d )"
        
        # SAM/SYSTEM registry hive dumping
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(reg.*save.*HKLM\\\\SAM|reg.*save.*HKLM\\\\SYSTEM|reg.*save.*HKLM\\\\SECURITY)"
        
        # Credential file access
        - type: "SensitivePathAccess"
          patterns:
            - "*\\Microsoft\\Credentials\\*"
            - "*\\Microsoft\\Protect\\*"
            - "*\\Microsoft\\Vault\\*"
          op_type: "Read"
          min_unique_paths: 2
        
        # NTDS.dit access
        - type: "File"
          op: "Read"
          path_pattern: "*\\NTDS\\ntds.dit"
        
        # Browser credential theft
        - type: "SensitivePathAccess"
          patterns:
            - "*\\User Data\\*Login Data*"
            - "*\\User Data\\*Cookies*"
            - "*\\Firefox\\Profiles\\*logins.json*"
            - "*\\Firefox\\Profiles\\*key4.db*"
          op_type: "Read"
          min_unique_paths: 3
        
        # Credential decryption
        - type: "Api"
          name_pattern: "(?i)(CryptUnprotectData|BCryptDecrypt)"
          module_pattern: "(?i)(crypt32|bcrypt)\\.dll"

    # ========================================================================
    # STAGE 7: NETWORK C2 PATTERNS
    # ========================================================================
    - name: "Network C2 Patterns"
      conditions:
        # Network connectivity (basic)
        - type: "Network"
          op: "Connect"
        
        # Suspicious user agents (XORed - from YARA)
        - type: "MemoryScan"
          patterns: 
            - "Mozilla/5.0"
            - "User-Agent:"
          detect_pe_headers: false
          private_only: false
        
        # C2 framework indicators
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(beacon|metasploit|meterpreter|empire|covenant|merlin|sliver|havoc|cobalt|koadic)"
        
        # Reverse shell patterns
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(nc.*-e.*cmd|ncat.*-e|/bin/(ba)?sh.*-i|perl.*socket|python.*socket)"
        
        # C2 over DNS
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(nslookup.*-type=txt|dig.*txt|Invoke-DNSExfiltration)"
        
        # Stratum protocol (crypto mining - from YARA)
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(stratum\\+tcp://|stratum\\+ssl://)"
        
        # Proxy usage
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Internet Settings\\ProxyServer*"

    # ========================================================================
    # STAGE 8: REFLECTIVE CODE LOADING
    # ========================================================================
    - name: "Reflective Code Loading"
      conditions:
        # PE headers in memory
        - type: "MemoryScan"
          patterns: []
          detect_pe_headers: true
          private_only: true
        
        # ReflectiveLoader export (from YARA)
        - type: "MemoryScan"
          patterns: ["ReflectiveLoader"]
          detect_pe_headers: false
          private_only: false
        
        # PE loading APIs
        - type: "Api"
          name_pattern: "(?i)(NtAllocateVirtualMemory|NtProtectVirtualMemory|NtCreateSection|NtMapViewOfSection)"
          module_pattern: "(?i)ntdll\\.dll"
        
        # Thread context manipulation
        - type: "Api"
          name_pattern: "(?i)(GetThreadContext|SetThreadContext|Wow64GetThreadContext|Wow64SetThreadContext)"
          module_pattern: "(?i)(kernel32|kernelbase)\\.dll"

    # ========================================================================
    # STAGE 9: PROCESS INJECTION TECHNIQUES
    # ========================================================================
    - name: "Process Injection Techniques"
      conditions:
        # Classic injection
        - type: "Api"
          name_pattern: "(?i)(VirtualAllocEx|WriteProcessMemory|CreateRemoteThread)"
          module_pattern: "(?i)kernel32\\.dll"
        
        # APC injection
        - type: "Api"
          name_pattern: "(?i)(QueueUserAPC|NtQueueApcThread)"
          module_pattern: "(?i)(kernel32|ntdll)\\.dll"
        
        # Process doppelgänging
        - type: "Api"
          name_pattern: "(?i)(NtCreateTransaction|RtlSetCurrentTransaction)"
          module_pattern: "(?i)ntdll\\.dll"
        
        # Early bird injection
        - type: "Api"
          name_pattern: "(?i)(CreateProcessA|CreateProcessW).*SUSPENDED"
          module_pattern: "(?i)kernel32\\.dll"
        
        # Atom bombing
        - type: "Api"
          name_pattern: "(?i)(GlobalAddAtom|GlobalGetAtomName|NtQueueApcThread)"
          module_pattern: "(?i)(kernel32|ntdll)\\.dll"

    # ========================================================================
    # STAGE 10: POWERSHELL ATTACK PATTERNS
    # ========================================================================
    - name: "PowerShell Attack Patterns"
      conditions:
        # Base64 encoded payloads (from YARA)
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(\\[System\\.Convert\\]::FromBase64String|::FromBase64String\\(|Convert.*FromBase64String)"
        
        # Download cradles
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(IEX.*New-Object.*Net\\.WebClient|iex.*downloadstring|Invoke-Expression.*downloadstring)"
        
        # Compact IEX usage (from YARA)
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(\\);\\s*iex|iex\\s*\\(|;iex)"
        
        # Reflection techniques
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(\\[Reflection\\.Assembly\\]::Load|Assembly.*Load\\(|GetType\\(.*Invoke)"
        
        # In-memory execution
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(Invoke-Mimikatz|Invoke-Shellcode|Invoke-DllInjection|Invoke-ReflectivePEInjection)"
        
        # PowerShell Empire indicators
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(powershell.*-sta.*-w.*hidden|System\\.Management\\.Automation\\.AMSIUtils)"
        
        # Obfuscation patterns (format string from YARA)
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(\\}\\{0\\}\"-f |\\{[0-9]+\\}.*-f.*\\[char\\])"

    # ========================================================================
    # STAGE 11: CODE OBFUSCATION
    # ========================================================================
    - name: "Code Obfuscation"
      conditions:
        # Character substitution
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(\\[char\\][0-9]{2,3}|char\\]0x[0-9a-f]{2})"
        
        # String concatenation abuse
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)([\"'][A-Za-z]{1,3}[\"']\\+[\"'][A-Za-z]{1,3}[\"'].*\\+.*[\"'][A-Za-z]{1,3}[\"'])"
        
        # Variable name randomization
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(\\$[a-z0-9]{20,}|\\$[A-Z]{1}[a-z0-9]{8}\\$)"
        
        # Format string obfuscation
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(-join|-f \\(|\\{[0-9].*\\}.*-f)"
        
        # Tick obfuscation
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)([a-z]`[a-z]`[a-z]|I`E`X|I`n`v)"
        
        # Compression obfuscation
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(IO\\.Compression|GZipStream|DeflateStream)"

    # ========================================================================
    # STAGE 12: EXPLOITATION INDICATORS
    # ========================================================================
    - name: "Exploitation Indicators"
      conditions:
        # Heap spray patterns
        - type: "Api"
          name_pattern: "(?i)(HeapCreate|HeapAlloc|VirtualAlloc)"
          module_pattern: "(?i)kernel32\\.dll"
        
        # ROP chain indicators
        - type: "MemoryScan"
          patterns: 
            - "pop.*ret"
            - "xchg.*esp"
          detect_pe_headers: false
          private_only: true
        
        # Shellcode patterns
        - type: "MemoryScan"
          patterns:
            - "\\x90\\x90\\x90\\x90"  # NOP sled
            - "\\xeb\\xfe"             # jmp $
          detect_pe_headers: false
          private_only: true
        
        # CVE exploitation indicators
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(CVE-[0-9]{4}-[0-9]{4,6}|MS[0-9]{2}-[0-9]{3})"
        
        # Exploit framework usage
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(metasploit|exploit|payload|shellcode|msfvenom)"

    # ========================================================================
    # STAGE 13: REMOTE PAYLOAD DOWNLOAD
    # ========================================================================
    - name: "Remote Payload Download"
      conditions:
        # HTTP/HTTPS downloads
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(curl.*http|wget.*http|bitsadmin.*/transfer|certutil.*urlcache.*http)"
        
        # PowerShell downloads
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(Invoke-WebRequest.*http|Start-BitsTransfer.*http|DownloadFile\\(.*http)"
        
        # DNS-based downloads
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(nslookup.*-q=txt|dig.*TXT.*@)"
        
        # FTP downloads
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(ftp.*-s:|ftp.*get |tftp.*get)"
        
        # Remote file access
        - type: "File"
          op: "Read"
          path_pattern: "\\\\*\\*\\*"

    # ========================================================================
    # STAGE 14: FILE STAGING & DROPPER
    # ========================================================================
    - name: "File Staging & Dropper"
      conditions:
        # Dropper behavior
        - type: "TempDirectoryWrite"
          min_bytes: 10240
          min_files: 2
        
        # Archive creation in temp
        - type: "ArchiveCreation"
          extensions: ["zip", "rar", "7z"]
          in_temp: true
          min_size: 5120
        
        # Multiple PE writes
        - type: "ExtensionPattern"
          patterns: ["*.exe", "*.dll", "*.sys"]
          match_mode:
            at_least: 2
          op_type: "Write"
        
        # Suspicious PDB paths (from YARA)
        - type: "MemoryScan"
          patterns:
            - "\\Debug\\Inject"
            - "\\Release\\Keylog"
            - "\\Stealer\\"
            - "\\Bypass\\"
            - "\\Dropper.pdb"
            - "\\Loader.pdb"
          detect_pe_headers: false
          private_only: false

    # ========================================================================
    # STAGE 15: OFFICE DOCUMENT EXPLOITATION
    # ========================================================================
    - name: "Office Document Exploitation"
      conditions:
        # Office spawning suspicious processes
        - type: "ProcessAncestry"
          ancestor_pattern: "(?i)(winword|excel|powerpnt|mspub|visio|outlook)\\.exe"
          max_depth: 1
        
        # Macro execution indicators
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(VBA|Macro|AutoOpen|Document_Open)"
        
        # DDE exploitation
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(DDEAUTO|DDE)"
        
        # OLE object execution
        - type: "File"
          op: "Create"
          path_pattern: "*\\OLE\\*"

    # ========================================================================
    # STAGE 16: SCRIPTING ENGINE ABUSE
    # ========================================================================
    - name: "Scripting Engine Abuse"
      conditions:
        # WSH abuse
        - type: "Process"
          op: "Spawn"
          pattern: "(?i)(wscript|cscript)\\.exe"
        
        # JScript/VBScript execution
        - type: "File"
          op: "Open"
          path_pattern: "*.(js|vbs|vbe|jse|wsf|wsh)"
        
        # MSHTA abuse
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(mshta.*http|mshta.*javascript|mshta.*vbscript)"
        
        # HTA file execution
        - type: "File"
          op: "Open"
          path_pattern: "*.hta"
        
        # COM scriptlet execution
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(scrobj\\.dll|regsvr32.*/i:http)"

    # ========================================================================
    # STAGE 17: NETWORK DISCOVERY
    # ========================================================================
    - name: "Network Discovery"
      conditions:
        # Network reconnaissance commands
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(ipconfig.*/all|nbtstat.*-A|arp.*-a|route.*print|netstat.*-ano)"
        
        # Domain enumeration
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(net.*view|net.*use|nltest|dsquery)"
        
        # Ping sweeps
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(ping.*-n.*[0-9]|for.*/L.*ping)"
        
        # Port scanning
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(nmap|masscan|Test-NetConnection.*-Port)"
        
        # Share enumeration
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(net.*share|net.*session|Invoke-ShareFinder)"

    # ========================================================================
    # STAGE 18: SYSTEM RECONNAISSANCE
    # ========================================================================
    - name: "System Reconnaissance"
      conditions:
        # System information gathering
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(systeminfo|wmic.*os.*get|wmic.*computersystem|Get-ComputerInfo)"
        
        # User enumeration
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(net.*user|net.*localgroup|whoami.*/all|Get-LocalUser)"
        
        # Process enumeration
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(tasklist|wmic.*process|Get-Process|ps.*aux)"
        
        # Service enumeration
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sc.*query|wmic.*service|Get-Service)"
        
        # Security software enumeration
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(wmic.*product|Get-WmiObject.*Win32_Product|tasklist.*/svc)"

    # ========================================================================
    # STAGE 19: DLL HIJACKING & SIDE-LOADING
    # ========================================================================
    - name: "DLL Hijacking & Side-Loading"
      conditions:
        # DLL writes to system paths
        - type: "File"
          op: "Write"
          path_pattern: "*\\System32\\*.dll"
        
        # DLL writes to program folders
        - type: "File"
          op: "Write"
          path_pattern: "*\\Program Files*\\*.dll"
        
        # Commonly hijacked DLLs
        - type: "File"
          op: "Create"
          path_pattern: "*(version|dwmapi|uxtheme|propsys|wintrust|winmm|msvcp140|vcruntime140|mscoree).dll"
        
        # DLL search order hijacking
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\KnownDLLs\\*"
        
        # Phantom DLL hijacking
        - type: "File"
          op: "Create"
          path_pattern: "*\\WindowsApps\\*.dll"

    # ========================================================================
    # STAGE 20: API MANIPULATION
    # ========================================================================
    - name: "API Manipulation"
      conditions:
        # IAT hooking
        - type: "Api"
          name_pattern: "(?i)(VirtualProtect|VirtualProtectEx)"
          module_pattern: "(?i)kernel32\\.dll"
        
        # Inline hooking
        - type: "Api"
          name_pattern: "(?i)(WriteProcessMemory|NtWriteVirtualMemory)"
          module_pattern: "(?i)(kernel32|ntdll)\\.dll"
        
        # API set manipulation
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\ApiSetSchema\\*"
        
        # Import Address Table manipulation
        - type: "MemoryScan"
          patterns: ["IMAGE_IMPORT_DESCRIPTOR"]
          detect_pe_headers: false
          private_only: true

    # ========================================================================
    # STAGE 21: ANTI-ANALYSIS TECHNIQUES
    # ========================================================================
    - name: "Anti-Analysis Techniques"
      conditions:
        # Debugger detection
        - type: "Api"
          name_pattern: "(?i)(IsDebuggerPresent|CheckRemoteDebuggerPresent|NtQueryInformationProcess)"
          module_pattern: "(?i)(kernel32|ntdll)\\.dll"
        
        # VM detection
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(wmic.*bios|wmic.*computersystem.*manufacturer|Get-WmiObject.*Win32_BIOS)"
        
        # Sandbox detection
        - type: "File"
          op: "Open"
          path_pattern: "*\\(sample|malware|virus|sandbox)*"
        
        # Sleep evasion
        - type: "Api"
          name_pattern: "(?i)(Sleep|NtDelayExecution|timeBeginPeriod)"
          module_pattern: "(?i)(kernel32|ntdll|winmm)\\.dll"
        
        # Environment checks
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(NUMBER_OF_PROCESSORS|PROCESSOR_IDENTIFIER|COMPUTERNAME)"

    # ========================================================================
    # STAGE 22: ROOTKIT INDICATORS
    # ========================================================================
    - name: "Rootkit Indicators"
      conditions:
        # Driver loading
        - type: "File"
          op: "Write"
          path_pattern: "*\\drivers\\*.sys"
        
        # Service installation for drivers
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sc.*create.*type.*kernel|sc.*config.*type.*kernel)"
        
        # Direct kernel object manipulation
        - type: "Api"
          name_pattern: "(?i)(ZwLoadDriver|NtLoadDriver)"
          module_pattern: "(?i)ntdll\\.dll"
        
        # SSDT hooking indicators
        - type: "MemoryScan"
          patterns: ["KeServiceDescriptorTable"]
          detect_pe_headers: false
          private_only: true

    # ========================================================================
    # STAGE 23: KERNEL-LEVEL OPERATIONS
    # ========================================================================
    - name: "Kernel-Level Operations"
      conditions:
        # Kernel mode APIs
        - type: "Api"
          name_pattern: "(?i)(NtCreateFile|NtWriteFile|NtReadFile|ZwCreateFile)"
          module_pattern: "(?i)ntdll\\.dll"
        
        # Device driver interaction
        - type: "File"
          op: "Open"
          path_pattern: "*\\\\.\\*"
        
        # Raw disk access
        - type: "File"
          op: "Open"
          path_pattern: "*\\\\.\\PhysicalDrive*"
        
        # Volume manipulation
        - type: "File"
          op: "Open"
          path_pattern: "*\\\\.\\*:"

    # ========================================================================
    # STAGE 24: CRITICAL SYSTEM MODIFICATION
    # ========================================================================
    - name: "Critical System Modification"
      conditions:
        # Boot configuration modification
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(bcdedit|bootrec|bootcfg)"
        
        # Master Boot Record access
        - type: "File"
          op: "Write"
          path_pattern: "*\\\\.\\PhysicalDrive0"
        
        # Safe mode configuration
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Control\\SafeBoot\\*"
        
        # Critical service modification
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\CurrentControlSet\\Services\\(MpsSvc|WinDefend|wscsvc)\\*"
        
        # Windows Update tampering
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\WindowsUpdate\\*"

    # ========================================================================
    # STAGE 25: WEBSHELL ACTIVITY
    # ========================================================================
    - name: "Webshell Activity"
      conditions:
        # Web server process spawning commands
        - type: "ProcessAncestry"
          ancestor_pattern: "(?i)(w3wp|httpd|nginx|apache|tomcat)\\.exe"
          max_depth: 1
        
        # Webshell common commands
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(whoami|net.*user|ipconfig|systeminfo|tasklist)"
        
        # PHP/ASP webshell indicators
        - type: "File"
          op: "Create"
          path_pattern: "*(inetpub|wwwroot|www|htdocs)*.(php|asp|aspx|jsp)"
        
        # Command execution through web
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(&cd&echo|cd.*/d.*&.*&)"

    # ========================================================================
    # STAGE 26: REMOTE COMMAND EXECUTION
    # ========================================================================
    - name: "Remote Command Execution"
      conditions:
        # PSExec-like behavior
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(psexec|paexec|winexe|wmiexec|smbexec)"
        
        # Remote registry access
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(reg.*\\\\\\\\[^\\s]+.*add|reg.*\\\\\\\\[^\\s]+.*query)"
        
        # Remote service execution
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sc.*\\\\\\\\[^\\s]+.*create|sc.*\\\\\\\\[^\\s]+.*start)"
        
        # Remote scheduled task
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(schtasks.*/s.*[^\\s]+.*/create)"
        
        # WinRM usage
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(winrs|Enter-PSSession|Invoke-Command.*-ComputerName)"

    # ========================================================================
    # STAGE 27: POST-EXPLOITATION ACTIVITY
    # ========================================================================
    - name: "Post-Exploitation Activity"
      conditions:
        # Data exfiltration prep
        - type: "DataExfiltrationPattern"
          source_patterns:
            - "*\\Documents\\*"
            - "*\\Desktop\\*"
            - "*.pdf"
            - "*.docx"
            - "*.xlsx"
          min_source_reads: 20
          detect_temp_staging: true
          detect_archive: true
        
        # Lateral movement indicators
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(net.*use.*\\$|copy.*\\\\\\\\[^\\s]+|xcopy.*\\\\\\\\[^\\s]+)"
        
        # RDP manipulation
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Terminal Server\\*"
        
        # Pass-the-hash indicators
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sekurlsa::pth|Invoke-WMIExec.*-Hash)"

    # ========================================================================
    # STAGE 28: SIGNATURE VERIFICATION FAILURE
    # ========================================================================
    - name: "Signature Verification Failure"
      conditions:
        # Unsigned executable
        - type: "Signature"
          is_trusted: false
        
        # Invalid signature
        - type: "Signature"
          is_trusted: false
          signer_pattern: null

    # ========================================================================
    # STAGE 29: SENSITIVE DATA ACCESS
    # ========================================================================
    - name: "Sensitive Data Access"
      conditions:
        # Multiple sensitive paths accessed
        - type: "SensitivePathAccess"
          patterns:
            - "*\\AppData\\*"
            - "*\\Users\\*\\Documents\\*"
            - "*\\Users\\*\\Desktop\\*"
            - "*\\Users\\*\\Downloads\\*"
            - "*\\ProgramData\\*"
          op_type: "Read"
          min_unique_paths: 10
        
        # High volume file reads
        - type: "OperationCount"
          op_type: "Read"
          comparison: "gte"
          threshold: 100
        
        # Broad directory spread
        - type: "DirectorySpread"
          category: "opened"
          comparison: "gte"
          threshold: 20

    # ========================================================================
    # STAGE 30: SECURITY TOOL TAMPERING
    # ========================================================================
    - name: "Security Tool Tampering"
      conditions:
        # Windows Defender tampering
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(Set-MpPreference.*-DisableRealtimeMonitoring|Add-MpPreference.*-ExclusionPath)"
        
        # Firewall rule manipulation
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(netsh.*firewall.*add.*allow|New-NetFirewallRule.*Allow)"
        
        # EDR/AV service stopping
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(sc.*stop.*(sense|windefend|mpssvc)|Stop-Service.*(defender|edr))"
        
        # Security event log clearing
        - type: "Process"
          op: "CommandLine"
          pattern: "(?i)(wevtutil.*cl.*security|Clear-EventLog.*Security)"
        
        # Tamper protection disable
        - type: "Registry"
          op: "SetValue"
          key_pattern: "*\\Windows Defender\\Features*"
          value_name: "TamperProtection"
          expected_data: "0"

  # ==========================================================================
  # RESPONSE ACTIONS
  # ==========================================================================
  response:
    terminate_process: true
    quarantine: true
    auto_revert: true
    record: true
    block_network: false
  
  # ==========================================================================
  # ALLOWLIST - Legitimate Tools (Must be digitally signed)
  # ==========================================================================
  allowlisted_apps:
    # System Tools
    - pattern: "svchost.exe"
      must_be_signed: true
      signers: ["Microsoft Windows", "Microsoft Corporation"]
    
    - pattern: "explorer.exe"
      must_be_signed: true
      signers: ["Microsoft Windows", "Microsoft Corporation"]
    
    - pattern: "services.exe"
      must_be_signed: true
      signers: ["Microsoft Windows"]
    
    # Browsers
    - pattern: "chrome.exe"
      must_be_signed: true
      signers: ["Google LLC"]
    
    - pattern: "firefox.exe"
      must_be_signed: true
      signers: ["Mozilla Corporation"]
    
    - pattern: "msedge.exe"
      must_be_signed: true
      signers: ["Microsoft Corporation"]
    
    # Security Tools
    - pattern: "MsMpEng.exe"
      must_be_signed: true
      signers: ["Microsoft Corporation"]
    
    - pattern: "SentinelAgent.exe"
      must_be_signed: true
      signers: ["SentinelOne"]
    
    - pattern: "CrowdStrike"
      must_be_signed: true
      signers: ["CrowdStrike"]
    
    # System Administration
    - pattern: "powershell.exe"
      must_be_signed: true
      signers: ["Microsoft Windows", "Microsoft Corporation"]
    
    - pattern: "cmd.exe"
      must_be_signed: true
      signers: ["Microsoft Windows", "Microsoft Corporation"]
    
    # Development Tools
    - "devenv.exe"
    - "code.exe"
    - "rider64.exe"
    - "java.exe"
    - "python.exe"
  